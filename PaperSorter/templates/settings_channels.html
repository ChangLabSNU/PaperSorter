{% extends "settings_base.html" %}

{% block title %}Channels - Settings - {{ site_name }}{% endblock %}
{% block header_title %}📡 Channels{% endblock %}

{% block page_styles %}
        /* Channel-specific tag styles */
        .tag {
            text-transform: uppercase;
            font-weight: 600;
        }

        .tag-active {
            background-color: var(--channels-tag-active-bg);
            color: var(--channels-tag-active-color);
        }

        .tag-inactive {
            background-color: var(--channels-tag-inactive-bg);
            color: var(--channels-tag-inactive-color);
        }

        .tag-discord {
            background-color: var(--channel-discord-bg);
            color: var(--channel-discord-color);
        }

        .tag-slack {
            background-color: var(--channel-slack-bg);
            color: var(--channel-slack-color);
        }

        .tag-email {
            background-color: var(--channel-email-bg);
            color: var(--channel-email-color);
        }

        .tag-unknown {
            background-color: var(--channel-unknown-bg);
            color: var(--channel-unknown-color);
        }

        .content-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 30px;
            box-shadow: var(--shadow-card);
            transition: background-color var(--transition-base);
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .action-bar h2 {
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--text-white);
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--color-danger);
            color: var(--text-white);
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-edit {
            background: var(--color-warning);
            color: var(--text-white);
            padding: 5px 15px;
            font-size: 14px;
        }

        .btn-edit:hover {
            background: #e67e22;
        }

        .btn-test {
            background: var(--channels-btn-test-bg);
            color: var(--text-white);
            padding: 5px 15px;
            font-size: 14px;
        }

        .btn-test:hover {
            background: var(--channels-btn-test-hover);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }

        .data-table th {
            background: var(--bg-table-header);
            font-weight: bold;
            color: var(--text-primary);
            transition: background-color var(--transition-base), color var(--transition-base);
        }

        .data-table tr:hover {
            background: var(--bg-hover);
        }

        .data-table td {
            color: var(--text-primary);
            transition: border-color var(--transition-base), color var(--transition-base);
        }

        .data-table strong {
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: var(--z-index-modal);
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-content {
            background-color: var(--bg-card);
            margin: 30px auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: var(--shadow-modal);
            position: relative;
            transition: background-color var(--transition-base);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-meta);
            cursor: pointer;
            transition: color var(--transition-base);
        }

        .close:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-medium);
            border-radius: 4px;
            font-size: 16px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: background-color var(--transition-base), color var(--transition-base), border-color var(--transition-base);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-group small {
            color: var(--channels-help-color);
            transition: color var(--transition-base);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .hours-scheduler {
            margin: 10px 0;
        }

        .hours-table {
            width: 100%;
            margin: 15px 0;
        }

        .hours-header {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin-bottom: 5px;
        }

        .hour-number {
            text-align: center;
            font-size: 11px;
            color: var(--channels-hour-number-color);
            font-weight: 500;
            transition: color var(--transition-base);
        }

        .hours-checkboxes {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
        }

        .hour-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--channels-hour-cell-bg);
            border: 1px solid var(--channels-hour-cell-border);
            border-radius: 2px;
            padding: 0;
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .hour-cell input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
            transform: scale(0.9);
        }

        .hour-cell input[type="checkbox"]:checked {
            accent-color: var(--channels-checkbox-accent);
        }

        .hours-controls {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .hours-controls button {
            padding: 4px 10px;
            font-size: 12px;
            background: var(--channels-hour-controls-bg);
            border: 1px solid var(--channels-hour-controls-border);
            border-radius: 4px;
            cursor: pointer;
            white-space: nowrap;
            color: var(--text-primary);
            transition: background-color var(--transition-base), border-color var(--transition-base), color var(--transition-base);
        }

        .hours-controls button:hover {
            background: var(--channels-hour-controls-hover);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-meta);
            transition: color var(--transition-base);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: var(--text-secondary);
            transition: color var(--transition-base);
        }

        /* Color states for endpoint validation */
        #endpointHelp.success {
            color: var(--channels-success-color) !important;
        }

        #endpointError.warning {
            color: var(--channels-warning-color) !important;
        }

        #endpointError.error {
            color: var(--channels-error-color) !important;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-links {
                flex-direction: column;
                width: 100%;
            }

            .action-bar {
                flex-direction: column;
                gap: 10px;
            }

            .data-table {
                font-size: 14px;
            }

            .actions {
                flex-direction: column;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
{% endblock %}

{% block settings_content %}
    <div class="action-bar">
            <h2>Broadcast Channels</h2>
            <button class="btn btn-primary" onclick="openAddModal()">+ Add Channel</button>
        </div>

        <div id="channels-list">
            <!-- Channels will be loaded here -->
            <div class="empty-state">
                <div class="empty-state-icon">📡</div>
                <h3>No channels configured</h3>
                <p>Add a channel to start broadcasting notifications</p>
            </div>
    </div>
{% endblock %}

{% block modals %}
    <!-- Add/Edit Channel Modal -->
    <div id="channelModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Channel</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="channelForm" onsubmit="saveChannel(event)">
                <input type="hidden" id="channelId">
                <div class="form-group">
                    <label for="channelName">Channel Name</label>
                    <input type="text" id="channelName" required placeholder="e.g., Slack #papers">
                </div>
                <div class="form-group">
                    <label for="channelEndpoint">Endpoint URL</label>
                    <input type="text" id="channelEndpoint" required placeholder="https://hooks.slack.com/... or mailto:user@example.com" onblur="validateEndpointField()">
                    <small id="endpointHelp">Supports Slack/Discord webhooks or email (use mailto:address@example.com for email newsletters)</small>
                    <small id="endpointError" style="display: none;"></small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="channelScoreThreshold">Score Threshold</label>
                        <input type="number" id="channelScoreThreshold" required
                               min="0" max="1" step="0.01" value="0.7"
                               placeholder="0.7">
                        <small>Min score to broadcast (0.0-1.0)</small>
                    </div>
                    <div class="form-group">
                        <label for="channelModelId">Model</label>
                        <select id="channelModelId" required>
                            <option value="">Loading models...</option>
                        </select>
                        <small>Scoring model to use</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="channelBroadcastLimit">Broadcast Limit</label>
                        <input type="number" id="channelBroadcastLimit" required
                               min="1" max="100" value="20"
                               placeholder="20">
                        <small>Max items per run</small>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Status</label>
                        <label style="display: inline-flex; align-items: center; font-weight: normal; white-space: nowrap;">
                            <input type="checkbox" id="channelIsActive" checked style="margin-right: 8px;">
                            <span>Channel is Active</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Broadcast Hours</label>
                    <div class="hours-scheduler">
                        <div class="hours-table">
                            <div class="hours-header" id="hoursHeader">
                                <!-- Hour numbers will be generated by JavaScript -->
                            </div>
                            <div class="hours-checkboxes" id="hoursGrid">
                                <!-- Checkboxes will be generated by JavaScript -->
                            </div>
                        </div>
                        <div class="hours-controls">
                            <button type="button" onclick="selectAllHours()">All Hours</button>
                            <button type="button" onclick="clearAllHours()">Clear</button>
                            <button type="button" onclick="selectBusinessHours()">Business (9-17)</button>
                            <button type="button" onclick="selectEveryMorning()">Every morning</button>
                            <button type="button" onclick="selectAfterMeals()">After meals</button>
                        </div>
                        <small>Select hours when broadcasting is allowed (server timezone)</small>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Channel</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block page_scripts %}
    <script>
        let channels = [];
        let models = [];

        // Initialize hours grid
        function initHoursGrid() {
            const header = document.getElementById('hoursHeader');
            const grid = document.getElementById('hoursGrid');

            header.innerHTML = '';
            grid.innerHTML = '';

            // Create header with hour numbers
            for (let hour = 0; hour < 24; hour++) {
                const div = document.createElement('div');
                div.className = 'hour-number';
                div.textContent = hour.toString();
                header.appendChild(div);
            }

            // Create checkboxes without labels
            for (let hour = 0; hour < 24; hour++) {
                const div = document.createElement('div');
                div.className = 'hour-cell';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `hour_${hour}`;
                checkbox.name = 'broadcast_hours';
                checkbox.value = hour;
                checkbox.checked = true; // Default to all hours allowed
                checkbox.title = `Hour ${hour}:00-${hour}:59`;

                div.appendChild(checkbox);
                grid.appendChild(div);
            }
        }

        // Set hours from array
        function setHoursFromArray(hoursArray) {
            if (!hoursArray || hoursArray.length !== 24) {
                // If no array or invalid, default to all checked (24/7 broadcasting)
                for (let hour = 0; hour < 24; hour++) {
                    const checkbox = document.getElementById(`hour_${hour}`);
                    if (checkbox) checkbox.checked = true;
                }
                return;
            }

            for (let hour = 0; hour < 24; hour++) {
                const checkbox = document.getElementById(`hour_${hour}`);
                if (checkbox) checkbox.checked = hoursArray[hour];
            }
        }

        // Get hours as array
        function getHoursAsArray() {
            const hoursArray = [];
            for (let hour = 0; hour < 24; hour++) {
                const checkbox = document.getElementById(`hour_${hour}`);
                hoursArray.push(checkbox ? checkbox.checked : false);
            }
            return hoursArray;
        }

        // Hour selection helpers
        function selectAllHours() {
            for (let hour = 0; hour < 24; hour++) {
                const checkbox = document.getElementById(`hour_${hour}`);
                if (checkbox) checkbox.checked = true;
            }
        }

        function clearAllHours() {
            for (let hour = 0; hour < 24; hour++) {
                const checkbox = document.getElementById(`hour_${hour}`);
                if (checkbox) checkbox.checked = false;
            }
        }

        function selectBusinessHours() {
            for (let hour = 0; hour < 24; hour++) {
                const checkbox = document.getElementById(`hour_${hour}`);
                if (checkbox) checkbox.checked = (hour >= 9 && hour <= 17);
            }
        }

        function selectEveryMorning() {
            for (let hour = 0; hour < 24; hour++) {
                const checkbox = document.getElementById(`hour_${hour}`);
                if (checkbox) checkbox.checked = (hour === 8);
            }
        }

        function selectAfterMeals() {
            for (let hour = 0; hour < 24; hour++) {
                const checkbox = document.getElementById(`hour_${hour}`);
                if (checkbox) checkbox.checked = (hour === 8 || hour === 12 || hour === 17);
            }
        }

        function loadModels() {
            fetch('/api/settings/models')
                .then(response => response.json())
                .then(data => {
                    models = data.models || [];
                    updateModelDropdown();
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    // Still update dropdown even on error, with default model
                    models = [{id: 1, name: 'Default Model'}];
                    updateModelDropdown();
                });
        }

        function updateModelDropdown() {
            const select = document.getElementById('channelModelId');
            const currentValue = select.value;

            // Clear existing options
            select.innerHTML = '';

            // Add models as options
            if (models.length === 0) {
                select.innerHTML = '<option value="1">Default Model (ID: 1)</option>';
            } else {
                // Sort models by ID in descending order (newest first)
                const sortedModels = [...models].sort((a, b) => b.id - a.id);

                sortedModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name ? `${model.name} (ID: ${model.id})` : `Model ${model.id}`;
                    if (model.is_active === false) {
                        option.textContent += ' [Inactive]';
                        option.style.color = '#999';
                    }
                    select.appendChild(option);
                });
            }

            // Restore previous value if it exists
            if (currentValue) {
                select.value = currentValue;
            } else if (models.length > 0) {
                // Default to newest active model or just newest model
                const sortedModels = [...models].sort((a, b) => b.id - a.id);
                const activeModel = sortedModels.find(m => m.is_active !== false);
                select.value = activeModel ? activeModel.id : sortedModels[0].id;
            }
        }

        function loadChannels() {
            fetch('/api/settings/channels')
                .then(response => response.json())
                .then(data => {
                    channels = data.channels;
                    renderChannels();
                })
                .catch(error => {
                    console.error('Error loading channels:', error);
                });
        }

        function renderChannels() {
            const container = document.getElementById('channels-list');

            if (channels.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📡</div>
                        <h3>No channels configured</h3>
                        <p>Add a channel to start broadcasting notifications</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Score Threshold</th>
                            <th>Model</th>
                            <th>Broadcast Limit</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${channels.map(channel => `
                            <tr>
                                <td>${channel.id}</td>
                                <td><strong>${channel.name}</strong></td>
                                <td>
                                    <span class="tag ${channel.webhook_type === 'Discord' ? 'tag-discord' : channel.webhook_type === 'Slack' ? 'tag-slack' : channel.webhook_type === 'Email' ? 'tag-email' : 'tag-unknown'}">
                                        ${channel.webhook_type || 'Unknown'}
                                    </span>
                                </td>
                                <td>${channel.score_threshold || 0.7}</td>
                                <td>${channel.model_name || `Model ${channel.model_id || 1}`}</td>
                                <td>${channel.broadcast_limit || 20}</td>
                                <td>
                                    <span class="tag ${channel.is_active !== false ? 'tag-active' : 'tag-inactive'}">
                                        ${channel.is_active !== false ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>
                                    <div class="actions">
                                        <button class="btn btn-test" onclick="testChannel(${channel.id})">Test</button>
                                        <button class="btn btn-edit" onclick="editChannel(${channel.id})">Edit</button>
                                        <button class="btn btn-danger" onclick="deleteChannel(${channel.id})">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add Channel';
            document.getElementById('channelForm').reset();
            document.getElementById('channelId').value = '';
            // Reset validation messages
            document.getElementById('endpointHelp').style.display = 'block';
            document.getElementById('endpointHelp').className = '';
            document.getElementById('endpointHelp').innerHTML = 'Supports Slack/Discord webhooks or email (use mailto:address@example.com for email newsletters)';
            document.getElementById('endpointError').style.display = 'none';
            // Reset hours to all checked (default)
            selectAllHours();
            document.getElementById('channelModal').style.display = 'block';
        }

        function editChannel(id) {
            const channel = channels.find(c => c.id === id);
            if (!channel) return;

            document.getElementById('modalTitle').textContent = 'Edit Channel';
            document.getElementById('channelId').value = channel.id;
            document.getElementById('channelName').value = channel.name;
            document.getElementById('channelEndpoint').value = channel.endpoint_url;
            document.getElementById('channelScoreThreshold').value = channel.score_threshold || 0.7;

            // Set model dropdown value
            const modelSelect = document.getElementById('channelModelId');
            modelSelect.value = channel.model_id || 1;
            // If the value doesn't exist in dropdown (e.g., model was deleted), add it temporarily
            if (modelSelect.value != (channel.model_id || 1)) {
                const option = document.createElement('option');
                option.value = channel.model_id || 1;
                option.textContent = `Model ${channel.model_id || 1} (Not Found)`;
                option.style.color = 'var(--channels-error-color)';
                modelSelect.appendChild(option);
                modelSelect.value = channel.model_id || 1;
            }

            document.getElementById('channelBroadcastLimit').value = channel.broadcast_limit || 20;
            document.getElementById('channelIsActive').checked = channel.is_active !== false;

            // Set broadcast hours
            setHoursFromArray(channel.broadcast_hours_array);

            // Validate the existing endpoint URL
            validateEndpointField();

            document.getElementById('channelModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('channelModal').style.display = 'none';
        }

        function validateEndpointUrl(url) {
            // Check if URL is a supported type
            if (!url) return { valid: false, message: 'Endpoint URL is required' };

            // Check for email format
            if (url.startsWith('mailto:')) {
                const email = url.substring(7);
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    return { valid: false, message: 'Invalid email address format' };
                }
                return { valid: true, type: 'Email' };
            }

            // Check for webhook URLs
            try {
                const parsedUrl = new URL(url);
                const hostname = parsedUrl.hostname.toLowerCase();

                if (hostname.includes('slack.com')) {
                    return { valid: true, type: 'Slack' };
                } else if (hostname.includes('discord.com') || hostname.includes('discordapp.com')) {
                    return { valid: true, type: 'Discord' };
                } else {
                    return {
                        valid: false,
                        message: 'Unsupported webhook URL. Only Slack (slack.com) and Discord (discord.com) webhooks are supported.',
                        warning: true
                    };
                }
            } catch (e) {
                return { valid: false, message: 'Invalid URL format. Use https://... for webhooks or mailto:email@example.com for email.' };
            }
        }

        function validateEndpointField() {
            const url = document.getElementById('channelEndpoint').value;
            const helpText = document.getElementById('endpointHelp');
            const errorText = document.getElementById('endpointError');

            if (!url) {
                // Reset to default state if empty
                helpText.style.display = 'block';
                helpText.className = '';
                errorText.style.display = 'none';
                return;
            }

            const validation = validateEndpointUrl(url);

            if (validation.valid) {
                // Show detected type
                helpText.style.display = 'block';
                helpText.className = 'success';
                helpText.innerHTML = `✓ Detected as ${validation.type} endpoint`;
                errorText.style.display = 'none';
            } else if (validation.warning) {
                // Show warning
                helpText.style.display = 'none';
                errorText.style.display = 'block';
                errorText.innerHTML = `⚠️ ${validation.message}`;
                errorText.className = 'warning';
            } else {
                // Show error
                helpText.style.display = 'none';
                errorText.style.display = 'block';
                errorText.innerHTML = `✗ ${validation.message}`;
                errorText.className = 'error';
            }
        }

        function saveChannel(event) {
            event.preventDefault();

            const id = document.getElementById('channelId').value;
            const endpoint_url = document.getElementById('channelEndpoint').value;

            // Validate endpoint URL
            const validation = validateEndpointUrl(endpoint_url);
            if (!validation.valid) {
                if (validation.warning) {
                    // Show warning but allow to proceed
                    if (!confirm(`Warning: ${validation.message}\n\nThis endpoint may not work correctly. Do you want to continue anyway?`)) {
                        return;
                    }
                } else {
                    // Show error and stop
                    alert(`Error: ${validation.message}`);
                    document.getElementById('channelEndpoint').focus();
                    return;
                }
            }

            const data = {
                name: document.getElementById('channelName').value,
                endpoint_url: endpoint_url,
                score_threshold: parseFloat(document.getElementById('channelScoreThreshold').value),
                model_id: parseInt(document.getElementById('channelModelId').value),
                broadcast_limit: parseInt(document.getElementById('channelBroadcastLimit').value),
                is_active: document.getElementById('channelIsActive').checked,
                broadcast_hours_array: getHoursAsArray()
            };

            const url = id ? `/api/settings/channels/${id}` : '/api/settings/channels';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    loadChannels();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving channel:', error);
                alert('Failed to save channel');
            });
        }

        function testChannel(id) {
            const channel = channels.find(c => c.id === id);
            if (!channel) return;

            const button = event.target;
            const originalText = button.innerText;
            button.innerText = 'Testing...';
            button.disabled = true;

            fetch(`/api/settings/channels/${id}/test`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`✅ ${data.message}`);
                } else {
                    alert(`❌ Test failed: ${data.error}`);
                }
            })
            .catch(error => {
                alert(`Error testing channel: ${error}`);
            })
            .finally(() => {
                button.innerText = originalText;
                button.disabled = false;
            });
        }

        function deleteChannel(id) {
            if (!confirm('Are you sure you want to delete this channel?')) return;

            fetch(`/api/settings/channels/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadChannels();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error deleting channel:', error);
                alert('Failed to delete channel');
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('channelModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Load channels and models on page load
        initHoursGrid();
        loadModels();
        loadChannels();
    </script>
{% endblock %}