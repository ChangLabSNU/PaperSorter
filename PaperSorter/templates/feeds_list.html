<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feeds - {{ site_name }}</title>
    <!-- CSS Variables for Dark Mode -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}">
    <!-- Feeds List CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feeds_list.css') }}">
    <!-- Common JavaScript utilities -->
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
</head>
<body data-theme="{{ current_user.theme | default('light') if current_user.is_authenticated else 'light' }}">
    <!-- Fixed hamburger menu -->
    <div class="hamburger-menu">
        <button class="hamburger-btn" onclick="toggleHamburgerMenu(event)">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
        </button>
        <div class="dropdown-menu" id="hamburgerDropdown">
            <!-- Display current user -->
            <div class="dropdown-user">
                <span>ğŸ‘¤ {{ current_user.username }}</span>
            </div>
            <div class="dropdown-divider"></div>
            {% if current_user.is_admin %}
            <button class="dropdown-item" onclick="toggleSemanticSearch(); closeHamburgerMenu();">
                <span>â• Add a Paper</span>
            </button>
            <div class="dropdown-divider"></div>
            <a href="/broadcast-queue" class="dropdown-item">
                <span>ğŸ“¤ Broadcast Queue</span>
            </a>
            <a href="/events" class="dropdown-item">
                <span>ğŸ“‹ Event Logs</span>
            </a>
            <div class="dropdown-divider"></div>
            <a href="/labeling" class="dropdown-item">
                <span>ğŸ·ï¸ Labeling Session</span>
            </a>
            <a href="/settings" class="dropdown-item">
                <span>âš™ï¸ System Settings</span>
            </a>
            <a href="/user-settings" class="dropdown-item">
                <span>ğŸ› ï¸ Personal Settings</span>
            </a>
            {% else %}
            <a href="/user-settings" class="dropdown-item">
                <span>âš™ï¸ï¸ Settings</span>
            </a>
            {% endif %}
            <div class="dropdown-divider"></div>
            <a href="/logout" class="dropdown-item">
                <span>ğŸšª Logout</span>
            </a>
        </div>
    </div>
    <div class="container">
        <div class="header">
            <h1>{{ site_name }}</h1>
            <div class="filter-controls">
                <!-- Control buttons for all users -->
                <button id="generalSearchToggleBtn" class="user-info btn-search" onclick="toggleGeneralSearch()">
                    <span style="margin-left: 0;">ğŸ” Search</span>
                </button>
                <button class="user-info btn-pdf" onclick="window.location.href='/pdf-search'">
                    <span style="margin-left: 0;">ğŸŒŒ PDF</span>
                </button>
                <div class="score-filter">
                    <div class="score-filter-label">Min Score</div>
                    <input type="range" id="scoreSlider" class="score-slider" min="0" max="4" value="2" step="1" oninput="updateScoreFilter(this.value)">
                    <div class="score-value" id="scoreValue">0.05</div>
                </div>
                <div class="score-filter">
                    <div class="score-filter-label">Channel</div>
                    <select id="channelSelector" class="channel-selector" onchange="onChannelChange()">
                        {% if not channels %}
                        <option value="">None</option>
                        {% endif %}
                        {% for channel in channels %}
                        <option value="{{ channel.id }}" {% if channel.id == primary_channel_id %}selected{% endif %}>
                            {{ channel.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <!-- Theme Toggle Button -->
                <button class="btn-theme-toggle" onclick="ThemeManager.toggleTheme()" title="Toggle dark/light mode">
                    <span class="theme-icon">ğŸŒ™</span>
                </button>
            </div>
        </div>

        <!-- General Search Interface -->
        <div id="generalSearchContainer" style="display: none;">
            <div class="search-interface">
                <textarea id="generalSearchInput" placeholder="Search by title, abstract, or any text. Press Enter to search, Shift+Enter for new line." class="search-textarea" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); performGeneralSearch(); }"></textarea>
                <button onclick="performGeneralSearch()" class="btn btn-primary search-btn">ğŸ” Search</button>
            </div>
        </div>


        <!-- General Search Results Container -->
        <div id="generalSearchResultsContainer" style="display: none;">
            <div class="search-results-header">
                <div style="flex: 1;">
                    <h2 style="margin-bottom: 8px;">Search Results</h2>
                    <p id="searchQueryDisplay" style="margin: 0; color: #7f8c8d; font-size: 14px;"></p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button onclick="copySearchLink(event)" class="btn btn-primary">ğŸ“‹ Copy Link</button>
                    <button onclick="backToFeedList()" class="btn btn-secondary">â† Back to Feed List</button>
                </div>
            </div>

            <!-- Summary Section -->
            <div class="summary-section" id="searchSummarySection" style="display: none;">
                <div class="summary-header">
                    <h3>AI Summary</h3>
                </div>
                <div class="summary-content" id="searchSummaryContent">
                    <div class="summary-initial" id="searchSummaryInitial">
                        <button class="btn btn-primary btn-generate" id="generateSearchSummaryBtn">Generate Summary</button>
                        <button class="btn btn-primary btn-generate" id="generateSearchPosterBtn">Generate Infographic</button>
                    </div>
                    <div class="summary-loading" id="searchSummaryLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Generating summary...</p>
                    </div>
                    <div class="poster-loading" id="searchPosterLoading" style="display: none;">
                        <div class="spinner"></div>
                        <p>Generating infographic poster...</p>
                        <p style="font-size: 13px; color: #5f6368; margin-top: 10px;">
                            This may take 3-5 minutes. Please wait...
                        </p>
                    </div>
                    <div class="summary-text" id="searchSummaryText"></div>
                    <div class="poster-content" id="searchPosterContent" style="display: none;"></div>
                </div>
            </div>

            <div class="feeds-container">
                <div id="generalSearchResults">
                    <!-- Search results will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Scholarly Database Search Interface -->
        <div id="semanticSearchContainer" style="display: none;">
            <div class="search-interface">
                <input type="text" id="semanticSearchInput" placeholder="Search for papers in scholarly database..." class="search-input" onkeydown="if(event.key === 'Enter') { searchSemanticScholar(event); }">
                <button onclick="searchSemanticScholar(event)" class="btn btn-primary">ğŸ” Search</button>
                <button onclick="backToFeedList()" class="btn btn-secondary">â† Back to Feed List</button>
            </div>
        </div>

        <!-- Search Results Container -->
        <div id="searchResultsContainer" style="display: none;">
            <div class="search-results-header">
                <h2 id="searchResultsTitle">Scholarly Database Search Results</h2>
                <div style="display: flex; gap: 10px;">
                    <button onclick="backToSearchInput()" class="btn btn-secondary">â† Back to Search</button>
                    <button onclick="backToFeedList()" class="btn btn-secondary">â† Back to Feed List</button>
                </div>
            </div>
            <div id="searchResults">
                <!-- Search results will be loaded here -->
            </div>
        </div>

        <div class="feeds-container" id="feedsContainer">
            <div id="feeds-list">
                <!-- Feeds will be loaded here -->
            </div>
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                Loading feeds...
            </div>
        </div>
    </div>

    <!-- Configuration for JavaScript -->
    <script>
        window.feedsConfig = {
            isAuthenticated: {% if current_user.is_authenticated %}true{% else %}false{% endif %},
            isAdmin: {% if current_user.is_admin %}true{% else %}false{% endif %},
            userTheme: '{{ current_user.theme if current_user.is_authenticated else "light" }}',
            minScore: {{ current_user.feedlist_minscore|default(0.25) }},
            userTimezone: '{{ current_user.timezone|default("") }}',
            bookmarkId: null
        };
    </script>

    <!-- External JavaScript -->
    <script src="{{ url_for('static', filename='js/feeds_list.js') }}"></script>

    <script>
        // Template-specific initialization that requires Jinja2 variables
        // Most functionality has been moved to feeds_list.js
        
        // Additional configuration that needs template processing
        window.feedsConfig.scoreThresholds = [0, 0.05, 0.1, 0.25, 0.5];
        window.feedsConfig.scoreLabels = ['Unlimited', 'â‰¥ 5', 'â‰¥ 10', 'â‰¥ 25', 'â‰¥ 50'];
        
        // All main functionality is now in feeds_list.js
        // The external script will initialize everything on DOMContentLoaded
    </script>
</body>
</html>
