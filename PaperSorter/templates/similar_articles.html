{% extends "base.html" %}

{% block title %}Similar Articles - {{ site_name }}{% endblock %}

{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/feed_struct.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feeds_list.css') }}">
    <style>
        /* Override base styles for this page */
        body {
            background-color: var(--bg-body);
        }

        main {
            background: transparent;
            box-shadow: none;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Hide the base template header on this page */
        body > .container > .header {
            display: none;
        }

        /* Custom header for this page that combines everything */
        .combined-header {
            background: var(--similar-header-bg);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--similar-header-shadow);
            transition: background-color var(--transition-base), box-shadow var(--transition-base);
        }

        .combined-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .combined-header h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 28px;
            font-weight: bold;
            transition: color var(--transition-base);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }


        .source-article {
            background: var(--similar-source-bg);
            border: 1px solid var(--similar-source-border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .source-article h3 {
            margin: 0 0 8px 0;
            color: var(--similar-source-title-color);
            font-size: 16px;
            transition: color var(--transition-base);
        }

        .source-article-title {
            font-weight: bold;
            color: var(--similar-source-text-color);
            margin-bottom: 5px;
            transition: color var(--transition-base);
        }

        .source-article-meta {
            font-size: 14px;
            color: var(--similar-source-meta-color);
            transition: color var(--transition-base);
        }

        /* Theme toggle button matching base template */
        .btn-theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 20px;
            transition: all var(--transition-base);
        }

        .btn-theme-toggle:hover {
            background: var(--bg-hover);
        }

        .feeds-container {
            background: var(--bg-card);
            border-radius: 8px;
            box-shadow: var(--shadow-card);
            overflow: hidden;
            transition: background-color var(--transition-base), box-shadow var(--transition-base);
        }

        .similarity-header {
            background: var(--bg-table-header);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-light);
            font-weight: bold;
            color: var(--text-primary);
            font-size: 16px;
            transition: background-color var(--transition-base), border-color var(--transition-base), color var(--transition-base);
        }

        .feed-item {
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .feed-item:hover {
            background-color: var(--bg-hover);
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        /* Essential layout styles */
        .feed-header {
            display: flex;
            align-items: center;
            padding: 20px;
            gap: 15px;
        }

        .badges-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .feed-content {
            flex: 1;
        }

        .feed-meta {
            display: flex;
            gap: 15px;
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-meta);
        }

        .feed-meta-item {
            display: inline-block;
        }

        .feed-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* feed-labels handled in shared CSS (not used here) */


        /* Badge styles: use shared score/similarity badge geometry from feed_struct.css */
        .label-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }



        .score-icon {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 1px solid white;
        }

        .score-icon.shared {
            background: var(--badge-shared-bg);
            color: white;
        }

        .score-icon.broadcasted {
            background: var(--badge-broadcasted-bg);
            color: white;
        }



        .feed-title {
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .feed-meta {
            color: var(--text-meta);
            transition: color var(--transition-base);
        }


        .feed-author {
            max-width: 200px;
        }







        .feed-details {
            display: none;
            padding: 20px;
            background: var(--bg-abstract);
            border-top: 1px solid var(--border-light);
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .feed-details.expanded {
            display: block;
        }

        .feed-abstract {
            padding: 0;
            color: var(--text-secondary);
            line-height: 1.6;
            transition: color var(--transition-base);
        }


        /* Button, loading, and generic helpers are provided by feeds_list.css/components.css */

        /* Summary Section Styles */
        .summary-section {
            background: var(--similar-feeds-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-subtle);
            transition: background-color var(--transition-base);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
        }

        .summary-header h3 {
            margin: 0;
            color: var(--similar-summary-header-color);
            font-size: 20px;
            transition: color var(--transition-base);
        }

        .btn-secondary-soft {
            background: var(--similar-btn-secondary-bg);
            color: var(--similar-btn-secondary-color);
            border: 1px solid var(--similar-btn-secondary-border);
        }

        .btn-secondary-soft:hover {
            background: var(--similar-btn-secondary-hover-bg);
            border-color: var(--similar-btn-secondary-hover-border);
        }

        .btn-sm { padding: 6px 12px; font-size: 13px; }

        .summary-content {
            position: relative;
            min-height: 70px;
        }

        .summary-initial {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 70px;
            gap: 12px;
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .btn-generate {
            background: var(--similar-btn-generate-bg);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 24px;
            cursor: pointer;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-card);
        }

        .btn-generate:hover {
            background: var(--similar-btn-generate-hover-bg);
            box-shadow: var(--shadow-hover);
            transform: translateY(-1px);
        }

        .btn-generate:active {
            transform: translateY(0);
            box-shadow: var(--shadow-card);
        }

        .summary-loading, .poster-loading {
            text-align: center;
            padding: 20px;
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .summary-loading p, .poster-loading p {
            color: var(--text-primary);
            margin: 10px 0;
            transition: color var(--transition-base);
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 4px solid var(--similar-loading-spinner-border);
            border-top: 4px solid var(--similar-btn-generate-bg);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .summary-text {
            font-size: 15px;
            line-height: 1.8;
            color: var(--similar-summary-text-color);
            transition: color var(--transition-base);
        }

        .summary-text h1, .summary-text h2, .summary-text h3 {
            color: var(--similar-summary-header-color);
            margin-top: 20px;
            margin-bottom: 10px;
            transition: color var(--transition-base);
        }

        .summary-text ul {
            margin: 10px 0;
            padding-left: 25px;
        }

        .summary-text li {
            margin: 5px 0;
        }

        .summary-text strong {
            color: var(--similar-summary-strong-color);
            transition: color var(--transition-base);
        }

        .summary-disclaimer {
            margin-top: 20px;
            padding: 12px 16px;
            background-color: var(--similar-disclaimer-bg);
            border-left: 3px solid var(--similar-disclaimer-border);
            border-radius: 4px;
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .summary-disclaimer p {
            margin: 0;
            font-size: 13px;
            color: var(--similar-disclaimer-color);
            line-height: 1.5;
            transition: color var(--transition-base);
        }

        .summary-disclaimer strong {
            color: var(--similar-disclaimer-strong-color);
            transition: color var(--transition-base);
        }

        .poster-content {
            width: 100%;
            margin-top: 20px;
        }

        .poster-iframe {
            width: 100%;
            height: 800px;
            border: 1px solid var(--similar-disclaimer-border);
            border-radius: 8px;
            box-shadow: var(--shadow-subtle);
        }

        .poster-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: flex-end;
        }

        .btn-print {
            background: var(--similar-btn-generate-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-print:hover {
            background: var(--similar-btn-generate-hover-bg);
            box-shadow: 0 2px 4px var(--shadow-lg);
        }

        .btn-print:active {
            transform: translateY(1px);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }


            .nav-buttons {
                flex-wrap: wrap;
            }

            .feed-header {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
            }

            .badges-container {
                margin-bottom: 7.5px;
            }

            .similarity-badge,
            .score-badge {
                min-width: 35px;
                padding: 4px 8px;
            }

            .feed-content {
                width: 100%;
            }

            .feed-meta {
                flex-direction: column;
                gap: 5px;
            }

            .feed-meta-item {
                max-width: none;
            }

            .feed-actions {
                flex-wrap: wrap;
                gap: 5px;
            }

            /* Mobile button tweaks are provided by feeds_list.css */

        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="combined-header">
            <div class="combined-header-top">
                <h1>Similar Articles</h1>
                <div class="header-actions">
                    <a href="/" class="nav-link">← Back to Papers</a>
                    <button class="btn-theme-toggle" onclick="ThemeManager.toggleTheme()" title="Toggle dark/light mode">
                        <span class="theme-icon">🌙</span>
                    </button>
                </div>
            </div>
            <div class="source-article" id="source-article">
                <h3>Finding articles similar to:</h3>
                <div class="source-article-title">Loading...</div>
                <div class="source-article-meta"></div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section" id="summary-section" style="display: none;">
            <div class="summary-header">
                <h3>AI Summary</h3>
            </div>
            <div class="summary-content" id="summary-content">
                <div class="summary-initial" id="summary-initial">
                    <button class="btn btn-primary-soft btn-generate" id="generate-summary-btn">Generate Summary</button>
                    <button class="btn btn-primary-soft btn-generate" id="generate-poster-btn">Generate Infographic</button>
                </div>
                <div class="summary-loading" id="summary-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating summary...</p>
                </div>
                <div class="poster-loading" id="poster-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating infographic poster...</p>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-top: 10px;">
                        This may take 3-5 minutes. Please wait...
                    </p>
                </div>
                <div class="summary-text" id="summary-text"></div>
                <div class="poster-content" id="poster-content" style="display: none;"></div>
            </div>
        </div>

        <div class="feeds-container">
            <div class="similarity-header">30 Most Similar Articles (Ordered by Similarity)</div>
            <div id="feeds-list">
                <!-- Similar papers will be loaded here -->
            </div>
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                Finding similar articles...
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const sourceFeedId = {{ source_feed_id }};
        const userTimezone = '{{ current_user.timezone }}';

        // Use the common gradient color function
        function calculateScoreColor(score) {
            return getScoreGradientColor(score);
        }


        function createFeedElement(feed) {
            const scoreColor = calculateScoreColor(feed.score);
            const similarityColor = getSimilarityGradientColor(feed.similarity);
            const scoreText = feed.score !== null ? Math.round(feed.score * 100).toString() : 'N/A';
            const similarityText = Math.round(feed.similarity * 100).toString();

            // Create icons for score badge
            let icons = [];
            if (feed.shared) icons.push('<span class="score-icon shared" title="In Queue">📤</span>');
            if (feed.broadcasted) icons.push('<span class="score-icon broadcasted" title="Broadcasted">📡</span>');
            const iconsHtml = icons.length > 0 ? `<div class="score-icons">${icons.join('')}</div>` : '';

            // Build vote badges (original feeds style)
            let voteBadges = [];
            const posCount = feed.positive_votes || 0;
            const negCount = feed.negative_votes || 0;
            if (posCount > 0) {
                voteBadges.push(`<span class=\"vote-badge vote-positive\" title=\"${posCount} interested\">+${posCount}</span>`);
            }
            if (negCount > 0) {
                voteBadges.push(`<span class=\"vote-badge vote-negative\" title=\"${negCount} not interested\">−${negCount}</span>`);
            }

            return `
                <div class="feed-item" data-feed-rowid="${feed.rowid}" data-positive-votes="${posCount}" data-negative-votes="${negCount}">
                    <div class="feed-header">
                        <div class="badges-container">
                            <span class="score-badge preference-score" style="background: ${scoreColor}" title="Predicted preference">
                                ${scoreText}
                                ${iconsHtml}
                            </span>
                            <span class="similarity-badge score-badge" style="background: ${similarityColor}" title="Similarity to selected paper">
                                ${similarityText}
                            </span>
                        </div>
                            <div class="feed-content">
                            <h3 class="feed-title">${feed.title}</h3>
                            <div class="feed-meta">
                                <div class="feed-meta-item feed-origin">${feed.origin || 'Unknown Source'}</div>
                                ${feed.author ? `<div class="feed-meta-item feed-author" title="${feed.author}">${formatAuthors(feed.author)}</div>` : ''}
                                <div class="feed-meta-item feed-date">${formatDate(feed.published || feed.added)}</div>
                            </div>
                        </div>
                        ${voteBadges.length > 0 ? `<div class=\"vote-badges-container\">${voteBadges.join('')}</div>` : ''}
                    </div>
                    <div class="feed-details">
                        <div class="feed-abstract">Loading content...</div>
                        <div class="feed-actions">
                            ${feed.link ? `<a href="${feed.link}" target="_blank" class="btn btn-open-article">📄<span class="btn-text">Open Article</span></a>` : ''}
                            <button class="btn btn-details" onclick="viewDetails(${feed.rowid})">
                                📄<span class="btn-text"> Details</span>
                            </button>
                            <button class="btn btn-share ${feed.shared ? 'shared' : ''} ${feed.broadcasted ? 'disabled' : ''}"
                                    onclick="shareFeed(${feed.rowid}, this, ${feed.broadcasted})"
                                    data-shared="${feed.shared ? 'true' : 'false'}"
                                    ${feed.broadcasted ? 'disabled title="Already broadcasted"' : ''}>
                                ${feed.broadcasted ? '📡' : '📤'}<span class="btn-text"> ${feed.broadcasted ? 'Broadcasted' : (feed.shared ? 'Shared' : 'Share')}</span>
                            </button>
                            <button class="btn btn-thumbs-up ${feed.label === 1 ? 'active' : ''}" onclick="feedbackFeed(${feed.rowid}, 1, this)" data-label="${feed.label}">
                                👍<span class="btn-text"> Interested</span>
                            </button>
                            <button class="btn btn-thumbs-down ${feed.label === 0 ? 'active' : ''}" onclick="feedbackFeed(${feed.rowid}, 0, this)" data-label="${feed.label}">
                                👎<span class="btn-text"> Not Interested</span>
                            </button>
                            
                        </div>
                    </div>
                </div>
            `;
        }

        let similarArticles = [];  // Store articles for summary generation

        function loadSimilarFeeds() {
            fetch(`/api/feeds/${sourceFeedId}/similar`)
                .then(response => response.json())
                .then(data => {
                    // Update source article info
                    if (data.source_article) {
                        document.querySelector('.source-article-title').textContent = data.source_article.title;

                        // Build meta text, skipping empty values
                        const metaParts = [];
                        if (data.source_article.author) metaParts.push(data.source_article.author);
                        if (data.source_article.origin) metaParts.push(data.source_article.origin);

                        document.querySelector('.source-article-meta').textContent = metaParts.join(' · ');
                    }

                    // Store articles for summary
                    if (data.similar_feeds) {
                        similarArticles = data.similar_feeds;
                        // Show summary section now that we have articles
                        document.getElementById('summary-section').style.display = 'block';
                    }

                    // Display similar papers
                    const feedsList = document.getElementById('feeds-list');
                    feedsList.innerHTML = '';

                    if (data.similar_feeds && data.similar_feeds.length > 0) {
                        data.similar_feeds.forEach(feed => {
                            feedsList.insertAdjacentHTML('beforeend', createFeedElement(feed));
                        });
                        document.getElementById('loading').style.display = 'none';
                    } else {
                        document.getElementById('loading').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--similar-loading-color);">No similar articles found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading similar papers:', error);
                    document.getElementById('loading').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--feedback-error-title-color);">Error loading similar papers</div>';
                });
        }

        function loadFeedContent(feedRowid, detailsElement) {
            fetch(`/api/feeds/${feedRowid}/content`)
                .then(response => response.json())
                .then(data => {
                    const abstractElement = detailsElement.querySelector('.feed-abstract');
                    if (data.content) {
                        abstractElement.textContent = data.content;
                    } else if (data.tldr) {
                        abstractElement.textContent = data.tldr;
                    } else {
                        abstractElement.textContent = 'No content available';
                    }
                })
                .catch(error => {
                    console.error('Error loading paper content:', error);
                    const abstractElement = detailsElement.querySelector('.feed-abstract');
                    abstractElement.textContent = 'Error loading content';
                    abstractElement.style.color = 'var(--feedback-error-title-color)';
                });
        }

        function shareFeed(feedRowid, buttonElement, isBroadcasted) {
            event.stopPropagation();

            // Prevent sharing if already broadcasted
            if (isBroadcasted) {
                return;
            }

            const isCurrentlyShared = buttonElement.dataset.shared === 'true';

            fetch(`/api/feeds/${feedRowid}/share`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'toggle'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const feedItem = buttonElement.closest('.feed-item');

                    // Update button immediately without intermediate state
                    if (data.action === 'share') {
                        // Update button state to shared
                        buttonElement.dataset.shared = 'true';
                        buttonElement.innerHTML = '📤<span class="btn-text"> Shared</span>';
                        buttonElement.classList.add('shared');

                        // Add icon to score badge
                        const scoreBadge = feedItem.querySelector('.badges-container .score-badge:not(.similarity-badge)');
                        if (scoreBadge) {
                            let scoreIcons = scoreBadge.querySelector('.score-icons');
                            if (!scoreIcons) {
                                scoreIcons = document.createElement('div');
                                scoreIcons.className = 'score-icons';
                                scoreBadge.appendChild(scoreIcons);
                            }
                            if (!scoreIcons.querySelector('.shared')) {
                                scoreIcons.insertAdjacentHTML('afterbegin', '<span class="score-icon shared" title="In Queue">📤</span>');
                            }
                        }
                    } else {  // unshare
                        // Update button state to unshared
                        buttonElement.dataset.shared = 'false';
                        buttonElement.innerHTML = '📤<span class="btn-text"> Share</span>';
                        buttonElement.classList.remove('shared');

                        // Remove icon from score badge
                        const scoreBadge = feedItem.querySelector('.badges-container .score-badge:not(.similarity-badge)');
                        const shareIcon = scoreBadge?.querySelector('.score-icon.shared');
                        if (shareIcon) {
                            shareIcon.remove();
                            // Remove icons container if empty
                            const scoreIcons = scoreBadge.querySelector('.score-icons');
                            if (scoreIcons && scoreIcons.children.length === 0) {
                                scoreIcons.remove();
                            }
                        }
                    }
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error toggling share:', error);
                buttonElement.innerHTML = isCurrentlyShared ? '📤<span class="btn-text"> Shared</span>' : '📤<span class="btn-text"> Share</span>';
                alert('Failed to update share. Please try again.');
            });
        }

        function feedbackFeed(feedRowid, score, buttonElement) {
            event.stopPropagation();

            const currentLabel = parseFloat(buttonElement.dataset.label);
            const isRemoving = currentLabel === score;

            buttonElement.disabled = true;
            const otherButton = score === 1
                ? buttonElement.nextElementSibling
                : buttonElement.previousElementSibling;
            if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                otherButton.disabled = true;
            }

            fetch(`/api/feeds/${feedRowid}/feedback`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    score: isRemoving ? null : score
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isRemoving) {
                        buttonElement.classList.remove('active');
                        buttonElement.dataset.label = '';
                    } else {
                        buttonElement.classList.add('active');
                        buttonElement.dataset.label = score;

                        if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                            otherButton.classList.remove('active');
                            otherButton.dataset.label = '';
                        }
                    }

                    const feedItem = buttonElement.closest('.feed-item');
                    let badgesDiv = feedItem.querySelector('.vote-badges-container');
                    const existingPositive = badgesDiv ? badgesDiv.querySelector('.vote-positive') : null;
                    const existingNegative = badgesDiv ? badgesDiv.querySelector('.vote-negative') : null;

                    // Get current vote counts from data attributes
                    let positiveCount = parseInt(feedItem.dataset.positiveVotes) || 0;
                    let negativeCount = parseInt(feedItem.dataset.negativeVotes) || 0;

                    // Adjust counts based on user action
                    if (isRemoving) {
                        if (score === 1) positiveCount = Math.max(0, positiveCount - 1);
                        else if (score === 0) negativeCount = Math.max(0, negativeCount - 1);
                    } else {
                        // Check if switching vote
                        const previousLabel = parseFloat(otherButton?.dataset.label);
                        if (previousLabel === 1 && score === 0) {
                            positiveCount = Math.max(0, positiveCount - 1);
                            negativeCount++;
                        } else if (previousLabel === 0 && score === 1) {
                            negativeCount = Math.max(0, negativeCount - 1);
                            positiveCount++;
                        } else if (score === 1) {
                            positiveCount++;
                        } else if (score === 0) {
                            negativeCount++;
                        }
                    }

                    // Update or create vote badges based on new counts
                    if (!badgesDiv && (positiveCount > 0 || negativeCount > 0)) {
                        const feedHeader = feedItem.querySelector('.feed-header');
                        feedHeader.insertAdjacentHTML('beforeend', '<div class="vote-badges-container"></div>');
                        badgesDiv = feedItem.querySelector('.vote-badges-container');
                    }

                    // Update positive votes badge
                    if (positiveCount > 0) {
                        if (existingPositive) {
                            existingPositive.textContent = `+${positiveCount}`;
                        } else if (badgesDiv) {
                            badgesDiv.insertAdjacentHTML('beforeend', `<span class=\"vote-badge vote-positive\">+${positiveCount}</span>`);
                        }
                    } else if (existingPositive) {
                        existingPositive.remove();
                    }

                    // Update negative votes badge
                    if (negativeCount > 0) {
                        if (existingNegative) {
                            existingNegative.textContent = `−${negativeCount}`;
                        } else if (badgesDiv) {
                            badgesDiv.insertAdjacentHTML('beforeend', `<span class=\"vote-badge vote-negative\">−${negativeCount}</span>`);
                        }
                    } else if (existingNegative) {
                        existingNegative.remove();
                    }

                    // Remove labels div if empty
                    if (badgesDiv && badgesDiv.children.length === 0) {
                        badgesDiv.remove();
                    }

                    // Update the feed data attributes for consistency
                    feedItem.dataset.positiveVotes = positiveCount;
                    feedItem.dataset.negativeVotes = negativeCount;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error updating feedback:', error);
                alert('Failed to update feedback. Please try again.');
            })
            .finally(() => {
                buttonElement.disabled = false;
                if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                    otherButton.disabled = false;
                }
            });
        }

        function moreLikeThis(feedRowid) {
            event.stopPropagation();
            window.location.href = `/similar/${feedRowid}`;
        }

        function viewDetails(feedRowid) {
            event.stopPropagation();
            window.location.href = `/paper/${feedRowid}`;
        }

        // Event delegation for paper clicks
        document.addEventListener('click', function(e) {
            if (e.target.closest('button') || e.target.closest('a')) return;

            const feedItem = e.target.closest('.feed-item');
            if (!feedItem) return;

            const detailsElement = feedItem.querySelector('.feed-details');
            const authorElement = feedItem.querySelector('.feed-author');
            const isExpanded = feedItem.classList.contains('expanded');

            if (isExpanded) {
                feedItem.classList.remove('expanded');
                detailsElement.classList.remove('expanded');

                // Restore shortened author list when collapsing
                if (authorElement && authorElement.dataset.fullAuthor) {
                    authorElement.textContent = formatAuthors(authorElement.dataset.fullAuthor);
                }
            } else {
                feedItem.classList.add('expanded');
                detailsElement.classList.add('expanded');

                // Show full author list when expanding
                if (authorElement && authorElement.title) {
                    authorElement.dataset.fullAuthor = authorElement.title; // Store full author list
                    authorElement.textContent = authorElement.title;
                }

                const abstractElement = detailsElement.querySelector('.feed-abstract');
                if (abstractElement.textContent === 'Loading content...') {
                    loadFeedContent(feedItem.dataset.feedRowid, detailsElement);
                }
            }
        });

        // Summary generation
        document.getElementById('generate-summary-btn').addEventListener('click', function() {
            const btn = this;
            const summaryInitial = document.getElementById('summary-initial');
            const summaryLoading = document.getElementById('summary-loading');
            const summaryText = document.getElementById('summary-text');

            // Hide button container and show loading
            summaryInitial.style.display = 'none';
            summaryLoading.style.display = 'block';
            summaryText.innerHTML = '';

            // Extract paper IDs from similar articles and include the source article
            const feedIds = [sourceFeedId, ...similarArticles.map(article => article.rowid)];

            // Call the summarization API with feed IDs including the source
            fetch('/api/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ feed_ids: feedIds })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    summaryText.innerHTML = data.summary_html + `
                        <div class="summary-disclaimer">
                            <p><strong>Note:</strong> This AI-generated summary is based solely on article titles and abstracts, not the full text.
                            The summary may contain inaccuracies or miss important details from the complete papers.
                            Please refer to the original articles for comprehensive information.</p>
                        </div>
                    `;
                } else {
                    summaryText.innerHTML = `<p style="color: var(--feedback-error-title-color);">Failed to generate summary: ${data.error || 'Unknown error'}</p>`;
                    // Show button again on failure
                    summaryInitial.style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('Error generating summary:', error);
                summaryText.innerHTML = '<p style="color: var(--feedback-error-title-color);">An error occurred while generating the summary.</p>';
                // Show button again on error
                summaryInitial.style.display = 'flex';
            })
            .finally(() => {
                summaryLoading.style.display = 'none';
            });
        });

        // Poster generation
        document.getElementById('generate-poster-btn').addEventListener('click', function() {
            const btn = this;
            const summaryInitial = document.getElementById('summary-initial');
            const posterLoading = document.getElementById('poster-loading');
            const summaryText = document.getElementById('summary-text');
            const posterContent = document.getElementById('poster-content');

            // Hide button container and show loading
            summaryInitial.style.display = 'none';
            posterLoading.style.display = 'block';
            summaryText.style.display = 'none';
            posterContent.style.display = 'none';

            // Extract feed IDs from similar articles and include the source article
            const feedIds = [sourceFeedId, ...similarArticles.map(article => article.rowid)];

            // Call the poster generation API to queue the job

            fetch('/api/generate-poster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ feed_ids: feedIds })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.job_id) {
                    // Start polling for job completion
                    const jobId = data.job_id;
                    const pollInterval = setInterval(() => {
                        fetch(`/api/poster-status/${jobId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(statusData => {
                                if (statusData.status === 'completed') {
                                    clearInterval(pollInterval);
                                    posterLoading.style.display = 'none';

                                    // Create an iframe to display the HTML poster with print button
                                    posterContent.innerHTML = `
                                        <div class="poster-actions">
                                            <button class="btn-print" onclick="printPoster()">
                                                🖨️ Print
                                            </button>
                                        </div>
                                        <iframe id="poster-iframe" class="poster-iframe" srcdoc="${statusData.poster_html.replace(/"/g, '&quot;')}" frameborder="0"></iframe>
                                        <div class="summary-disclaimer">
                                            <p><strong>Note:</strong> This AI-generated infographic is based solely on article titles and abstracts, not the full text.
                                            The visualization may contain inaccuracies or miss important details from the complete papers.
                                            Please refer to the original articles for comprehensive information.</p>
                                        </div>
                                    `;
                                    posterContent.style.display = 'block';

                                } else if (statusData.status === 'error') {
                                    clearInterval(pollInterval);
                                    posterLoading.style.display = 'none';

                                    posterContent.innerHTML = `<p style="color: var(--feedback-error-title-color);">Failed to generate poster: ${statusData.error || 'Unknown error'}</p>`;
                                    posterContent.style.display = 'block';
                                    // Show button again on failure
                                    summaryInitial.style.display = 'flex';
                                }
                                // If status is 'pending' or 'processing', continue polling
                            })
                            .catch(error => {
                                clearInterval(pollInterval);
                                posterLoading.style.display = 'none';

                                posterContent.innerHTML = `<p style="color: var(--feedback-error-title-color);">An error occurred while checking job status: ${error.message}</p>`;
                                posterContent.style.display = 'block';
                                // Show button again on error
                                summaryInitial.style.display = 'flex';
                            });
                    }, 3000); // Poll every 3 seconds

                    // Stop polling after 5 minutes
                    setTimeout(() => {
                        clearInterval(pollInterval);
                        if (posterLoading.style.display !== 'none') {
                            posterLoading.style.display = 'none';
                            posterContent.innerHTML = `<p style="color: var(--feedback-error-title-color);">Generation timed out. Please try again.</p>`;
                            posterContent.style.display = 'block';
                            summaryInitial.style.display = 'flex';
                        }
                    }, 300000); // 5 minutes timeout

                } else {
                    throw new Error('Failed to create job');
                }
            })
            .catch(error => {
                posterLoading.style.display = 'none';
                posterContent.innerHTML = `<p style="color: var(--feedback-error-title-color);">An error occurred while generating the poster: ${error.message}</p>`;
                posterContent.style.display = 'block';
                // Show button again on error
                summaryInitial.style.display = 'flex';
            });
        });

        // Print poster function
        function printPoster() {
            const iframe = document.getElementById('poster-iframe');
            if (iframe && iframe.contentWindow) {
                // Focus on the iframe and print its contents
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
            } else {
                alert('Unable to print poster. Please try again.');
            }
        }

        // Override ThemeManager's updateThemeIcon to ensure it works with our custom header
        if (typeof ThemeManager !== 'undefined') {
            const originalUpdateThemeIcon = ThemeManager.updateThemeIcon;
            ThemeManager.updateThemeIcon = function(theme) {
                // Call original function first
                originalUpdateThemeIcon.call(this, theme);
                // Also update our custom header's icon
                const icon = document.querySelector('.combined-header .theme-icon');
                if (icon) {
                    icon.textContent = theme === 'dark' ? '☀️' : '🌙';
                }
            };
        }

        // Initialize theme icon on page load
        window.addEventListener('load', function() {
            setTimeout(function() {
                const currentTheme = document.body.getAttribute('data-theme') || 'light';
                const icon = document.querySelector('.theme-icon');
                if (icon) {
                    icon.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
                }
            }, 100);
        });

        // Initial load
        loadSimilarFeeds();
    </script>
{% endblock %}
