{% extends "base.html" %}

{% block title %}Similar Articles - {{ site_name }}{% endblock %}

{% block styles %}
    <style>
        /* Override base styles for this page */
        body {
            background-color: var(--bg-body);
        }

        main {
            background: transparent;
            box-shadow: none;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Hide the base template header on this page */
        body > .container > .header {
            display: none;
        }

        /* Custom header for this page that combines everything */
        .combined-header {
            background: var(--similar-header-bg);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--similar-header-shadow);
            transition: background-color var(--transition-base), box-shadow var(--transition-base);
        }

        .combined-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .combined-header h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 28px;
            font-weight: bold;
            transition: color var(--transition-base);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }


        .source-article {
            background: var(--similar-source-bg);
            border: 1px solid var(--similar-source-border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .source-article h3 {
            margin: 0 0 8px 0;
            color: var(--similar-source-title-color);
            font-size: 16px;
            transition: color var(--transition-base);
        }

        .source-article-title {
            font-weight: bold;
            color: var(--similar-source-text-color);
            margin-bottom: 5px;
            transition: color var(--transition-base);
        }

        .source-article-meta {
            font-size: 14px;
            color: var(--similar-source-meta-color);
            transition: color var(--transition-base);
        }

        /* Match Settings page nav-link style */
        .nav-link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: bold;
            padding: 10px 20px;
            border: 2px solid var(--color-primary);
            border-radius: 6px;
            transition: all var(--transition-base);
            display: inline-block;
        }

        .nav-link:hover {
            background: var(--color-primary);
            color: var(--text-white);
        }

        /* Theme toggle button matching base template */
        .btn-theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 20px;
            transition: all var(--transition-base);
        }

        .btn-theme-toggle:hover {
            background: var(--bg-hover);
        }

        .feeds-container {
            background: var(--similar-feeds-bg);
            border-radius: 8px;
            box-shadow: var(--similar-feeds-shadow);
            overflow: hidden;
            transition: background-color var(--transition-base), box-shadow var(--transition-base);
        }

        .similarity-header {
            background: var(--similar-similarity-header-bg);
            padding: 15px 20px;
            border-bottom: 1px solid var(--similar-similarity-header-border);
            font-weight: bold;
            color: var(--similar-similarity-header-color);
            font-size: 16px;
            transition: background-color var(--transition-base), border-color var(--transition-base), color var(--transition-base);
        }

        .feed-item {
            border-bottom: 1px solid var(--similar-feed-item-border);
            cursor: pointer;
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .feed-item:hover {
            background-color: var(--similar-feed-item-hover-bg);
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            min-width: 50px;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .similarity-badge {
            color: white;
            min-width: 49px;
        }

        .score-icons {
            position: absolute;
            top: -8px;
            right: -8px;
            display: flex;
            gap: 2px;
        }

        .score-icon {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border: 1px solid white;
        }

        .score-icon.shared {
            background: var(--similar-shared-icon-bg);
            color: white;
        }

        .score-icon.broadcasted {
            background: var(--similar-broadcasted-icon-bg);
            color: white;
        }


        .feed-content {
            flex: 1;
            min-width: 0;
        }

        .feed-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--similar-feed-title-color);
            margin-bottom: 5px;
            line-height: 1.3;
            transition: color var(--transition-base);
        }

        .feed-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: var(--similar-feed-meta-color);
            margin-bottom: 5px;
            transition: color var(--transition-base);
        }

        .feed-meta-item {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .feed-author {
            max-width: 200px;
        }

        .feed-origin {
            font-weight: bold;
        }

        .feed-date {
            flex-shrink: 0;
        }

        .feed-labels {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
            flex-shrink: 0;
        }

        .label-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .label-shared {
            background: var(--similar-label-shared-icon-bg);
            color: white;
        }

        .label-broadcasted {
            background: var(--similar-label-positive-bg);
            color: white;
        }

        .label-positive {
            background: var(--similar-label-positive-bg);
            color: white;
        }

        .label-negative {
            background: var(--similar-label-negative-bg);
            color: white;
        }

        .feed-details {
            display: none;
            padding: 20px;
            background: var(--similar-feed-details-bg);
            border-top: 1px solid var(--similar-feed-details-border);
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .feed-details.expanded {
            display: block;
        }

        .feed-abstract {
            font-size: 15px;
            line-height: 1.6;
            color: var(--similar-feed-abstract-color);
            margin-bottom: 15px;
            transition: color var(--transition-base);
        }

        .feed-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all var(--transition-base);
        }

        .btn-primary {
            background: var(--similar-btn-primary-bg);
            color: var(--similar-btn-primary-color);
            border: 1px solid var(--similar-btn-primary-border);
        }

        .btn-primary:hover {
            background: var(--similar-btn-primary-hover-bg);
            border-color: var(--similar-btn-primary-hover-border);
        }

        .btn-open-article {
            background: var(--btn-open-article-bg);
            color: var(--btn-open-article-color);
            border: 1px solid var(--btn-open-article-border);
            text-decoration: none;
        }

        .btn-open-article:hover {
            background: var(--btn-open-article-bg-hover);
            border-color: var(--btn-open-article-border-hover);
            text-decoration: none;
        }

        .btn-share {
            background: var(--similar-btn-share-bg);
            color: var(--similar-btn-share-color);
            border: 1px solid var(--similar-btn-share-border);
        }

        .btn-share:hover {
            background: var(--similar-btn-share-hover-bg);
            border-color: var(--similar-btn-share-hover-border);
        }

        .btn-share.shared {
            background: var(--similar-btn-share-shared-bg);
            border-color: var(--similar-btn-share-shared-border);
            color: var(--similar-btn-share-shared-color);
        }

        .btn-share.disabled,
        .btn-share:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: var(--btn-secondary-bg);
            color: var(--text-meta);
            border-color: var(--border-medium);
        }

        .btn-thumbs-up {
            background: var(--similar-btn-thumbs-up-bg);
            color: var(--similar-btn-thumbs-up-color);
            border: 1px solid var(--similar-btn-thumbs-up-border);
        }

        .btn-thumbs-up:hover {
            background: var(--similar-btn-thumbs-up-hover-bg);
            border-color: var(--similar-btn-thumbs-up-hover-border);
        }

        .btn-thumbs-up.active {
            background: var(--similar-btn-thumbs-up-active-bg);
            border-color: var(--similar-btn-thumbs-up-active-border);
            color: var(--similar-btn-thumbs-up-active-color);
        }

        .btn-thumbs-down {
            background: var(--similar-btn-thumbs-down-bg);
            color: var(--similar-btn-thumbs-down-color);
            border: 1px solid var(--similar-btn-thumbs-down-border);
        }

        .btn-thumbs-down:hover {
            background: var(--similar-btn-thumbs-down-hover-bg);
            border-color: var(--similar-btn-thumbs-down-hover-border);
        }

        .btn-thumbs-down.active {
            background: var(--similar-btn-thumbs-down-active-bg);
            border-color: var(--similar-btn-thumbs-down-active-border);
            color: var(--similar-btn-thumbs-down-active-color);
        }

        .btn-similar {
            background: var(--similar-btn-similar-bg);
            color: var(--similar-btn-similar-color);
            border: 1px solid var(--similar-btn-similar-border);
        }

        .btn-similar:hover {
            background: var(--similar-btn-similar-hover-bg);
            border-color: var(--similar-btn-similar-hover-border);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--similar-loading-color);
            font-size: 16px;
            transition: color var(--transition-base);
        }

        .loading-spinner {
            border: 3px solid var(--similar-loading-spinner-border);
            border-top: 3px solid var(--similar-loading-spinner-top);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badges-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-text {
            margin-left: 5px;
        }

        /* Summary Section Styles */
        .summary-section {
            background: var(--similar-feeds-bg);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: background-color var(--transition-base);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .summary-header h3 {
            margin: 0;
            color: var(--similar-summary-header-color);
            font-size: 20px;
            transition: color var(--transition-base);
        }

        .btn-secondary {
            background: var(--similar-btn-secondary-bg);
            color: var(--similar-btn-secondary-color);
            border: 1px solid var(--similar-btn-secondary-border);
        }

        .btn-secondary:hover {
            background: var(--similar-btn-secondary-hover-bg);
            border-color: var(--similar-btn-secondary-hover-border);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .summary-content {
            position: relative;
            min-height: 120px;
        }

        .summary-initial {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 120px;
            gap: 12px;
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .btn-generate {
            background: var(--similar-btn-generate-bg);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 24px;
            cursor: pointer;
            transition: all var(--transition-base);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-generate:hover {
            background: var(--similar-btn-generate-hover-bg);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .btn-generate:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-loading, .poster-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-primary);
            transition: color var(--transition-base);
        }

        .summary-loading p, .poster-loading p {
            color: var(--text-primary);
            margin: 10px 0;
            transition: color var(--transition-base);
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 4px solid var(--similar-loading-spinner-border);
            border-top: 4px solid var(--similar-btn-generate-bg);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .summary-text {
            font-size: 15px;
            line-height: 1.8;
            color: var(--similar-summary-text-color);
            transition: color var(--transition-base);
        }

        .summary-text h1, .summary-text h2, .summary-text h3 {
            color: var(--similar-summary-header-color);
            margin-top: 20px;
            margin-bottom: 10px;
            transition: color var(--transition-base);
        }

        .summary-text ul {
            margin: 10px 0;
            padding-left: 25px;
        }

        .summary-text li {
            margin: 5px 0;
        }

        .summary-text strong {
            color: var(--similar-summary-strong-color);
            transition: color var(--transition-base);
        }

        .summary-disclaimer {
            margin-top: 20px;
            padding: 12px 16px;
            background-color: var(--similar-disclaimer-bg);
            border-left: 3px solid var(--similar-disclaimer-border);
            border-radius: 4px;
            transition: background-color var(--transition-base), border-color var(--transition-base);
        }

        .summary-disclaimer p {
            margin: 0;
            font-size: 13px;
            color: var(--similar-disclaimer-color);
            line-height: 1.5;
            transition: color var(--transition-base);
        }

        .summary-disclaimer strong {
            color: var(--similar-disclaimer-strong-color);
            transition: color var(--transition-base);
        }

        .poster-content {
            width: 100%;
            margin-top: 20px;
        }

        .poster-iframe {
            width: 100%;
            height: 800px;
            border: 1px solid var(--similar-disclaimer-border);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .poster-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: flex-end;
        }

        .btn-print {
            background: var(--similar-btn-generate-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 4px;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-print:hover {
            background: var(--similar-btn-generate-hover-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .btn-print:active {
            transform: translateY(1px);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }


            .nav-buttons {
                flex-wrap: wrap;
            }

            .feed-header {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
            }

            .badges-container {
                margin-bottom: 7.5px;
            }

            .similarity-badge,
            .score-badge {
                min-width: 35px;
                padding: 4px 8px;
            }

            .feed-content {
                width: 100%;
            }

            .feed-meta {
                flex-direction: column;
                gap: 5px;
            }

            .feed-meta-item {
                max-width: none;
            }

            .feed-labels {
                position: absolute;
                top: 15px;
                right: 15px;
                margin: 0;
                width: auto;
            }

            .feed-actions {
                flex-wrap: wrap;
                gap: 5px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 16px;
                min-width: 44px;
                text-align: center;
            }

            .btn-text {
                display: none;
            }

            .btn-primary {
                background: var(--similar-btn-primary-bg);
                color: var(--similar-btn-primary-color);
                border-color: var(--similar-btn-primary-border);
            }

            .btn-primary:hover {
                background: var(--similar-btn-primary-hover-bg);
                border-color: var(--similar-btn-primary-hover-border);
            }

            .btn-share.shared {
                background: var(--similar-shared-icon-bg);
                color: white;
                border-color: var(--similar-shared-icon-bg);
            }

            .btn-thumbs-up.active {
                background: var(--similar-label-positive-bg);
                color: white;
                border-color: var(--similar-label-positive-bg);
            }

            .btn-thumbs-down.active {
                background: var(--similar-label-negative-bg);
                color: white;
                border-color: var(--similar-label-negative-bg);
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="combined-header">
            <div class="combined-header-top">
                <h1>Similar Articles</h1>
                <div class="header-actions">
                    <a href="/" class="nav-link">← Back to Papers</a>
                    <button class="btn-theme-toggle" onclick="ThemeManager.toggleTheme()" title="Toggle dark/light mode">
                        <span class="theme-icon">🌙</span>
                    </button>
                </div>
            </div>
            <div class="source-article" id="source-article">
                <h3>Finding articles similar to:</h3>
                <div class="source-article-title">Loading...</div>
                <div class="source-article-meta"></div>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section" id="summary-section" style="display: none;">
            <div class="summary-header">
                <h3>AI Summary</h3>
            </div>
            <div class="summary-content" id="summary-content">
                <div class="summary-initial" id="summary-initial">
                    <button class="btn btn-primary btn-generate" id="generate-summary-btn">Generate Summary</button>
                    <button class="btn btn-primary btn-generate" id="generate-poster-btn">Generate Infographic</button>
                </div>
                <div class="summary-loading" id="summary-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating summary...</p>
                </div>
                <div class="poster-loading" id="poster-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating infographic poster...</p>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-top: 10px;">
                        This may take 3-5 minutes. Please wait...
                    </p>
                </div>
                <div class="summary-text" id="summary-text"></div>
                <div class="poster-content" id="poster-content" style="display: none;"></div>
            </div>
        </div>

        <div class="feeds-container">
            <div class="similarity-header">30 Most Similar Articles (Ordered by Similarity)</div>
            <div id="feeds-list">
                <!-- Similar papers will be loaded here -->
            </div>
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                Finding similar articles...
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const sourceFeedId = {{ source_feed_id }};
        const userTimezone = '{{ current_user.timezone }}';

        // Use the common gradient color function
        function calculateScoreColor(score) {
            return getScoreGradientColor(score);
        }


        function createFeedElement(feed) {
            const scoreColor = calculateScoreColor(feed.score);
            const similarityColor = getSimilarityGradientColor(feed.similarity);
            const scoreText = feed.score !== null ? Math.round(feed.score * 100).toString() : 'N/A';
            const similarityText = Math.round(feed.similarity * 100).toString();

            // Create icons for score badge
            let icons = [];
            if (feed.shared) icons.push('<div class="score-icon shared" title="In Queue">📤</div>');
            if (feed.broadcasted) icons.push('<div class="score-icon broadcasted" title="Broadcasted">📡</div>');
            const iconsHtml = icons.length > 0 ? `<div class="score-icons">${icons.join('')}</div>` : '';

            let labels = [];

            // Show vote badges with counts (including current user's vote)
            if (feed.positive_votes > 0 || feed.label === 1) {
                const count = feed.positive_votes || 0;
                labels.push(`<span class="label-badge label-positive">+${count}</span>`);
            }
            if (feed.negative_votes > 0 || feed.label === 0) {
                const count = feed.negative_votes || 0;
                labels.push(`<span class="label-badge label-negative">−${count}</span>`);
            }

            return `
                <div class="feed-item" data-feed-rowid="${feed.rowid}" data-positive-votes="${feed.positive_votes || 0}" data-negative-votes="${feed.negative_votes || 0}">
                    <div class="feed-header">
                        <div class="badges-container">
                            <div class="similarity-badge score-badge" style="background-color: ${similarityColor};">
                                ${similarityText}
                            </div>
                            <div class="score-badge" style="background-color: ${scoreColor};">
                                ${scoreText}
                                ${iconsHtml}
                            </div>
                        </div>
                        <div class="feed-content">
                            <div class="feed-title">${feed.title}</div>
                            <div class="feed-meta">
                                <div class="feed-meta-item feed-origin">${feed.origin || 'Unknown Source'}</div>
                                ${feed.author ? `<div class="feed-meta-item feed-author">${feed.author}</div>` : ''}
                                <div class="feed-meta-item feed-date">${formatDate(feed.published || feed.added)}</div>
                            </div>
                        </div>
                        ${labels.length > 0 ? `<div class="feed-labels">${labels.join('')}</div>` : ''}
                    </div>
                    <div class="feed-details">
                        <div class="feed-abstract">Loading content...</div>
                        <div class="feed-actions">
                            ${feed.link ? `<a href="${feed.link}" target="_blank" class="btn btn-open-article">🔗<span class="btn-text">Open Paper</span></a>` : ''}
                            <button class="btn btn-share ${feed.shared ? 'shared' : ''} ${feed.broadcasted ? 'disabled' : ''}"
                                    onclick="shareFeed(${feed.rowid}, this, ${feed.broadcasted})"
                                    data-shared="${feed.shared ? 'true' : 'false'}"
                                    ${feed.broadcasted ? 'disabled title="Already broadcasted"' : ''}>
                                ${feed.broadcasted ? '📡' : '📤'}<span class="btn-text"> ${feed.broadcasted ? 'Broadcasted' : (feed.shared ? 'Shared' : 'Share')}</span>
                            </button>
                            <button class="btn btn-thumbs-up ${feed.label === 1 ? 'active' : ''}" onclick="feedbackFeed(${feed.rowid}, 1, this)" data-label="${feed.label}">
                                👍<span class="btn-text"> Interested</span>
                            </button>
                            <button class="btn btn-thumbs-down ${feed.label === 0 ? 'active' : ''}" onclick="feedbackFeed(${feed.rowid}, 0, this)" data-label="${feed.label}">
                                👎<span class="btn-text"> Not Interested</span>
                            </button>
                            <button class="btn btn-similar" onclick="moreLikeThis(${feed.rowid})">
                                🔍<span class="btn-text"> More Like This</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        let similarArticles = [];  // Store articles for summary generation

        function loadSimilarFeeds() {
            fetch(`/api/feeds/${sourceFeedId}/similar`)
                .then(response => response.json())
                .then(data => {
                    // Update source article info
                    if (data.source_article) {
                        document.querySelector('.source-article-title').textContent = data.source_article.title;

                        // Build meta text, skipping empty values
                        const metaParts = [];
                        if (data.source_article.author) metaParts.push(data.source_article.author);
                        if (data.source_article.origin) metaParts.push(data.source_article.origin);

                        document.querySelector('.source-article-meta').textContent = metaParts.join(' · ');
                    }

                    // Store articles for summary
                    if (data.similar_feeds) {
                        similarArticles = data.similar_feeds;
                        // Show summary section now that we have articles
                        document.getElementById('summary-section').style.display = 'block';
                    }

                    // Display similar papers
                    const feedsList = document.getElementById('feeds-list');
                    feedsList.innerHTML = '';

                    if (data.similar_feeds && data.similar_feeds.length > 0) {
                        data.similar_feeds.forEach(feed => {
                            feedsList.insertAdjacentHTML('beforeend', createFeedElement(feed));
                        });
                        document.getElementById('loading').style.display = 'none';
                    } else {
                        document.getElementById('loading').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--similar-loading-color);">No similar articles found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading similar papers:', error);
                    document.getElementById('loading').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--feedback-error-title-color);">Error loading similar papers</div>';
                });
        }

        function loadFeedContent(feedRowid, detailsElement) {
            fetch(`/api/feeds/${feedRowid}/content`)
                .then(response => response.json())
                .then(data => {
                    const abstractElement = detailsElement.querySelector('.feed-abstract');
                    if (data.content) {
                        abstractElement.textContent = data.content;
                    } else if (data.tldr) {
                        abstractElement.textContent = data.tldr;
                    } else {
                        abstractElement.textContent = 'No content available';
                    }
                })
                .catch(error => {
                    console.error('Error loading paper content:', error);
                    const abstractElement = detailsElement.querySelector('.feed-abstract');
                    abstractElement.textContent = 'Error loading content';
                    abstractElement.style.color = 'var(--feedback-error-title-color)';
                });
        }

        function shareFeed(feedRowid, buttonElement, isBroadcasted) {
            event.stopPropagation();

            // Prevent sharing if already broadcasted
            if (isBroadcasted) {
                return;
            }

            const isCurrentlyShared = buttonElement.dataset.shared === 'true';

            fetch(`/api/feeds/${feedRowid}/share`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'toggle'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const feedItem = buttonElement.closest('.feed-item');

                    // Update button immediately without intermediate state
                    if (data.action === 'share') {
                        // Update button state to shared
                        buttonElement.dataset.shared = 'true';
                        buttonElement.innerHTML = '📤<span class="btn-text"> Shared</span>';
                        buttonElement.classList.add('shared');

                        // Add icon to score badge
                        const scoreBadge = feedItem.querySelector('.badges-container .score-badge:not(.similarity-badge)');
                        if (scoreBadge) {
                            let scoreIcons = scoreBadge.querySelector('.score-icons');
                            if (!scoreIcons) {
                                scoreIcons = document.createElement('div');
                                scoreIcons.className = 'score-icons';
                                scoreBadge.appendChild(scoreIcons);
                            }
                            if (!scoreIcons.querySelector('.shared')) {
                                scoreIcons.insertAdjacentHTML('afterbegin', '<span class="score-icon shared" title="In Queue">📤</span>');
                            }
                        }
                    } else {  // unshare
                        // Update button state to unshared
                        buttonElement.dataset.shared = 'false';
                        buttonElement.innerHTML = '📤<span class="btn-text"> Share</span>';
                        buttonElement.classList.remove('shared');

                        // Remove icon from score badge
                        const scoreBadge = feedItem.querySelector('.badges-container .score-badge:not(.similarity-badge)');
                        const shareIcon = scoreBadge?.querySelector('.score-icon.shared');
                        if (shareIcon) {
                            shareIcon.remove();
                            // Remove icons container if empty
                            const scoreIcons = scoreBadge.querySelector('.score-icons');
                            if (scoreIcons && scoreIcons.children.length === 0) {
                                scoreIcons.remove();
                            }
                        }
                    }
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error toggling share:', error);
                buttonElement.innerHTML = isCurrentlyShared ? '📤<span class="btn-text"> Shared</span>' : '📤<span class="btn-text"> Share</span>';
                alert('Failed to update share. Please try again.');
            });
        }

        function feedbackFeed(feedRowid, score, buttonElement) {
            event.stopPropagation();

            const currentLabel = parseFloat(buttonElement.dataset.label);
            const isRemoving = currentLabel === score;

            buttonElement.disabled = true;
            const otherButton = score === 1
                ? buttonElement.nextElementSibling
                : buttonElement.previousElementSibling;
            if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                otherButton.disabled = true;
            }

            fetch(`/api/feeds/${feedRowid}/feedback`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    score: isRemoving ? null : score
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isRemoving) {
                        buttonElement.classList.remove('active');
                        buttonElement.dataset.label = '';
                    } else {
                        buttonElement.classList.add('active');
                        buttonElement.dataset.label = score;

                        if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                            otherButton.classList.remove('active');
                            otherButton.dataset.label = '';
                        }
                    }

                    const feedItem = buttonElement.closest('.feed-item');
                    let labelsDiv = feedItem.querySelector('.feed-labels');
                    const existingPositive = labelsDiv ? labelsDiv.querySelector('.label-positive') : null;
                    const existingNegative = labelsDiv ? labelsDiv.querySelector('.label-negative') : null;

                    // Get current vote counts from data attributes
                    let positiveCount = parseInt(feedItem.dataset.positiveVotes) || 0;
                    let negativeCount = parseInt(feedItem.dataset.negativeVotes) || 0;

                    // Adjust counts based on user action
                    if (isRemoving) {
                        if (score === 1) positiveCount = Math.max(0, positiveCount - 1);
                        else if (score === 0) negativeCount = Math.max(0, negativeCount - 1);
                    } else {
                        // Check if switching vote
                        const previousLabel = parseFloat(otherButton?.dataset.label);
                        if (previousLabel === 1 && score === 0) {
                            positiveCount = Math.max(0, positiveCount - 1);
                            negativeCount++;
                        } else if (previousLabel === 0 && score === 1) {
                            negativeCount = Math.max(0, negativeCount - 1);
                            positiveCount++;
                        } else if (score === 1) {
                            positiveCount++;
                        } else if (score === 0) {
                            negativeCount++;
                        }
                    }

                    // Update or remove labels based on new counts
                    if (!labelsDiv && (positiveCount > 0 || negativeCount > 0)) {
                        const feedHeader = feedItem.querySelector('.feed-header');
                        feedHeader.insertAdjacentHTML('beforeend', '<div class="feed-labels"></div>');
                        labelsDiv = feedItem.querySelector('.feed-labels');
                    }

                    // Update positive votes badge
                    if (positiveCount > 0) {
                        if (existingPositive) {
                            existingPositive.textContent = `+${positiveCount}`;
                        } else if (labelsDiv) {
                            labelsDiv.insertAdjacentHTML('beforeend', `<span class="label-badge label-positive">+${positiveCount}</span>`);
                        }
                    } else if (existingPositive) {
                        existingPositive.remove();
                    }

                    // Update negative votes badge
                    if (negativeCount > 0) {
                        if (existingNegative) {
                            existingNegative.textContent = `−${negativeCount}`;
                        } else if (labelsDiv) {
                            labelsDiv.insertAdjacentHTML('beforeend', `<span class="label-badge label-negative">−${negativeCount}</span>`);
                        }
                    } else if (existingNegative) {
                        existingNegative.remove();
                    }

                    // Remove labels div if empty
                    if (labelsDiv && labelsDiv.children.length === 0) {
                        labelsDiv.remove();
                    }

                    // Update the feed data attributes for consistency
                    feedItem.dataset.positiveVotes = positiveCount;
                    feedItem.dataset.negativeVotes = negativeCount;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error updating feedback:', error);
                alert('Failed to update feedback. Please try again.');
            })
            .finally(() => {
                buttonElement.disabled = false;
                if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                    otherButton.disabled = false;
                }
            });
        }

        function moreLikeThis(feedRowid) {
            event.stopPropagation();
            window.location.href = `/similar/${feedRowid}`;
        }

        // Event delegation for paper clicks
        document.addEventListener('click', function(e) {
            if (e.target.closest('button') || e.target.closest('a')) return;

            const feedItem = e.target.closest('.feed-item');
            if (!feedItem) return;

            const detailsElement = feedItem.querySelector('.feed-details');
            const isExpanded = feedItem.classList.contains('expanded');

            if (isExpanded) {
                feedItem.classList.remove('expanded');
                detailsElement.classList.remove('expanded');
            } else {
                feedItem.classList.add('expanded');
                detailsElement.classList.add('expanded');

                const abstractElement = detailsElement.querySelector('.feed-abstract');
                if (abstractElement.textContent === 'Loading content...') {
                    loadFeedContent(feedItem.dataset.feedRowid, detailsElement);
                }
            }
        });

        // Summary generation
        document.getElementById('generate-summary-btn').addEventListener('click', function() {
            const btn = this;
            const summaryInitial = document.getElementById('summary-initial');
            const summaryLoading = document.getElementById('summary-loading');
            const summaryText = document.getElementById('summary-text');

            // Hide button container and show loading
            summaryInitial.style.display = 'none';
            summaryLoading.style.display = 'block';
            summaryText.innerHTML = '';

            // Extract paper IDs from similar articles and include the source article
            const feedIds = [sourceFeedId, ...similarArticles.map(article => article.rowid)];

            // Call the summarization API with feed IDs including the source
            fetch('/api/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ feed_ids: feedIds })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    summaryText.innerHTML = data.summary_html + `
                        <div class="summary-disclaimer">
                            <p><strong>Note:</strong> This AI-generated summary is based solely on article titles and abstracts, not the full text.
                            The summary may contain inaccuracies or miss important details from the complete papers.
                            Please refer to the original articles for comprehensive information.</p>
                        </div>
                    `;
                } else {
                    summaryText.innerHTML = `<p style="color: var(--feedback-error-title-color);">Failed to generate summary: ${data.error || 'Unknown error'}</p>`;
                    // Show button again on failure
                    summaryInitial.style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('Error generating summary:', error);
                summaryText.innerHTML = '<p style="color: var(--feedback-error-title-color);">An error occurred while generating the summary.</p>';
                // Show button again on error
                summaryInitial.style.display = 'flex';
            })
            .finally(() => {
                summaryLoading.style.display = 'none';
            });
        });

        // Poster generation
        document.getElementById('generate-poster-btn').addEventListener('click', function() {
            const btn = this;
            const summaryInitial = document.getElementById('summary-initial');
            const posterLoading = document.getElementById('poster-loading');
            const summaryText = document.getElementById('summary-text');
            const posterContent = document.getElementById('poster-content');

            // Hide button container and show loading
            summaryInitial.style.display = 'none';
            posterLoading.style.display = 'block';
            summaryText.style.display = 'none';
            posterContent.style.display = 'none';

            // Extract feed IDs from similar articles and include the source article
            const feedIds = [sourceFeedId, ...similarArticles.map(article => article.rowid)];

            // Call the poster generation API to queue the job

            fetch('/api/generate-poster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ feed_ids: feedIds })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.job_id) {
                    // Start polling for job completion
                    const jobId = data.job_id;
                    const pollInterval = setInterval(() => {
                        fetch(`/api/poster-status/${jobId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(statusData => {
                                if (statusData.status === 'completed') {
                                    clearInterval(pollInterval);
                                    posterLoading.style.display = 'none';

                                    // Create an iframe to display the HTML poster with print button
                                    posterContent.innerHTML = `
                                        <div class="poster-actions">
                                            <button class="btn-print" onclick="printPoster()">
                                                🖨️ Print
                                            </button>
                                        </div>
                                        <iframe id="poster-iframe" class="poster-iframe" srcdoc="${statusData.poster_html.replace(/"/g, '&quot;')}" frameborder="0"></iframe>
                                        <div class="summary-disclaimer">
                                            <p><strong>Note:</strong> This AI-generated infographic is based solely on article titles and abstracts, not the full text.
                                            The visualization may contain inaccuracies or miss important details from the complete papers.
                                            Please refer to the original articles for comprehensive information.</p>
                                        </div>
                                    `;
                                    posterContent.style.display = 'block';

                                } else if (statusData.status === 'error') {
                                    clearInterval(pollInterval);
                                    posterLoading.style.display = 'none';

                                    posterContent.innerHTML = `<p style="color: var(--feedback-error-title-color);">Failed to generate poster: ${statusData.error || 'Unknown error'}</p>`;
                                    posterContent.style.display = 'block';
                                    // Show button again on failure
                                    summaryInitial.style.display = 'flex';
                                }
                                // If status is 'pending' or 'processing', continue polling
                            })
                            .catch(error => {
                                clearInterval(pollInterval);
                                posterLoading.style.display = 'none';

                                posterContent.innerHTML = `<p style="color: var(--feedback-error-title-color);">An error occurred while checking job status: ${error.message}</p>`;
                                posterContent.style.display = 'block';
                                // Show button again on error
                                summaryInitial.style.display = 'flex';
                            });
                    }, 3000); // Poll every 3 seconds

                    // Stop polling after 5 minutes
                    setTimeout(() => {
                        clearInterval(pollInterval);
                        if (posterLoading.style.display !== 'none') {
                            posterLoading.style.display = 'none';
                            posterContent.innerHTML = `<p style="color: var(--feedback-error-title-color);">Generation timed out. Please try again.</p>`;
                            posterContent.style.display = 'block';
                            summaryInitial.style.display = 'flex';
                        }
                    }, 300000); // 5 minutes timeout

                } else {
                    throw new Error('Failed to create job');
                }
            })
            .catch(error => {
                posterLoading.style.display = 'none';
                posterContent.innerHTML = `<p style="color: var(--feedback-error-title-color);">An error occurred while generating the poster: ${error.message}</p>`;
                posterContent.style.display = 'block';
                // Show button again on error
                summaryInitial.style.display = 'flex';
            });
        });

        // Print poster function
        function printPoster() {
            const iframe = document.getElementById('poster-iframe');
            if (iframe && iframe.contentWindow) {
                // Focus on the iframe and print its contents
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
            } else {
                alert('Unable to print poster. Please try again.');
            }
        }

        // Override ThemeManager's updateThemeIcon to ensure it works with our custom header
        if (typeof ThemeManager !== 'undefined') {
            const originalUpdateThemeIcon = ThemeManager.updateThemeIcon;
            ThemeManager.updateThemeIcon = function(theme) {
                // Call original function first
                originalUpdateThemeIcon.call(this, theme);
                // Also update our custom header's icon
                const icon = document.querySelector('.combined-header .theme-icon');
                if (icon) {
                    icon.textContent = theme === 'dark' ? '☀️' : '🌙';
                }
            };
        }

        // Initialize theme icon on page load
        window.addEventListener('load', function() {
            setTimeout(function() {
                const currentTheme = document.body.getAttribute('data-theme') || 'light';
                const icon = document.querySelector('.theme-icon');
                if (icon) {
                    icon.textContent = currentTheme === 'dark' ? '☀️' : '🌙';
                }
            }, 100);
        });

        // Initial load
        loadSimilarFeeds();
    </script>
{% endblock %}