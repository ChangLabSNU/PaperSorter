<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Similar Articles - PaperSorter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            background: #e8f5e9;
            border-radius: 20px;
            font-weight: 600;
            color: #2e7d32;
            font-size: 14px;
            gap: 8px;
        }

        .user-icon {
            width: 24px;
            height: 24px;
            background: #4caf50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .header h1 {
            margin: 0;
            color: #2c3e50;
        }

        .source-article {
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .source-article h3 {
            margin: 0 0 8px 0;
            color: #388e3c;
            font-size: 16px;
        }

        .source-article-title {
            font-weight: bold;
            color: #2e7d32;
            margin-bottom: 5px;
        }

        .source-article-meta {
            font-size: 14px;
            color: #558b2f;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .nav-link {
            color: #3498db;
            text-decoration: none;
            font-weight: bold;
            padding: 10px 20px;
            border: 2px solid #3498db;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .nav-link:hover {
            background: #3498db;
            color: white;
        }

        .feeds-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .similarity-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            font-weight: bold;
            color: #2c3e50;
            font-size: 16px;
        }

        .feed-item {
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .feed-item:hover {
            background-color: #f8f9fa;
        }

        .feed-item:last-child {
            border-bottom: none;
        }

        .feed-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .score-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            color: white;
            min-width: 50px;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .similarity-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-width: 49px;
        }

        .score-icons {
            position: absolute;
            top: -8px;
            right: -8px;
            display: flex;
            gap: 2px;
        }

        .score-icon {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border: 1px solid white;
        }

        .score-icon.starred {
            background: #f39c12;
            color: white;
        }

        .score-icon.broadcasted {
            background: #3498db;
            color: white;
        }

        .feed-content {
            flex: 1;
            min-width: 0;
        }

        .feed-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .feed-meta {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .feed-meta-item {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .feed-author {
            max-width: 200px;
        }

        .feed-origin {
            font-weight: bold;
        }

        .feed-date {
            flex-shrink: 0;
        }

        .feed-labels {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-left: auto;
            flex-shrink: 0;
        }

        .label-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }

        .label-starred {
            background: #f39c12;
            color: white;
        }

        .label-positive {
            background: #27ae60;
            color: white;
        }

        .label-negative {
            background: #e74c3c;
            color: white;
        }

        .feed-details {
            display: none;
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .feed-details.expanded {
            display: block;
        }

        .feed-abstract {
            font-size: 15px;
            line-height: 1.6;
            color: #34495e;
            margin-bottom: 15px;
        }

        .feed-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
        }

        .btn-primary:hover {
            background: #bbdefb;
            border-color: #64b5f6;
        }

        .btn-star {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffcc80;
        }

        .btn-star:hover {
            background: #ffe0b2;
            border-color: #ffb74d;
        }

        .btn-star.starred {
            background: #ffcc80;
            border-color: #ff9800;
            color: #e65100;
        }

        .btn-thumbs-up {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #a5d6a7;
        }

        .btn-thumbs-up:hover {
            background: #c8e6c9;
            border-color: #81c784;
        }

        .btn-thumbs-up.active {
            background: #a5d6a7;
            border-color: #66bb6a;
            color: #2e7d32;
        }

        .btn-thumbs-down {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ef9a9a;
        }

        .btn-thumbs-down:hover {
            background: #ffcdd2;
            border-color: #e57373;
        }

        .btn-thumbs-down.active {
            background: #ef9a9a;
            border-color: #ef5350;
            color: #c62828;
        }

        .btn-similar {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #ce93d8;
        }

        .btn-similar:hover {
            background: #e1bee7;
            border-color: #ba68c8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 16px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badges-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-text {
            margin-left: 5px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header-top {
                flex-direction: column;
                gap: 10px;
            }

            .nav-buttons {
                flex-wrap: wrap;
            }

            .feed-header {
                padding: 15px;
                flex-direction: column;
                align-items: flex-start;
            }

            .badges-container {
                margin-bottom: 7.5px;
            }

            .similarity-badge,
            .score-badge {
                min-width: 35px;
                padding: 4px 8px;
            }

            .feed-content {
                width: 100%;
            }

            .feed-meta {
                flex-direction: column;
                gap: 5px;
            }

            .feed-meta-item {
                max-width: none;
            }

            .feed-labels {
                position: absolute;
                top: 15px;
                right: 15px;
                margin: 0;
                width: auto;
            }

            .feed-actions {
                flex-wrap: wrap;
                gap: 5px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 16px;
                min-width: 44px;
                text-align: center;
            }

            .btn-text {
                display: none;
            }

            .btn-primary {
                background: #e3f2fd;
                color: #1976d2;
                border-color: #90caf9;
            }

            .btn-primary:hover {
                background: #bbdefb;
                border-color: #64b5f6;
            }

            .btn-star.starred {
                background: #f39c12;
                color: white;
                border-color: #f39c12;
            }

            .btn-thumbs-up.active {
                background: #27ae60;
                color: white;
                border-color: #27ae60;
            }

            .btn-thumbs-down.active {
                background: #e74c3c;
                color: white;
                border-color: #e74c3c;
            }
        }

        /* Summary Section Styles */
        .summary-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .summary-header h3 {
            margin: 0;
            color: #1a73e8;
            font-size: 20px;
        }

        .btn-secondary {
            background: #f1f3f4;
            color: #3c4043;
            border: 1px solid #dadce0;
        }

        .btn-secondary:hover {
            background: #e8eaed;
            border-color: #5f6368;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .summary-content {
            position: relative;
            min-height: 120px;
        }

        .summary-initial {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 120px;
            gap: 12px;
        }

        .btn-generate {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            border-radius: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-generate:hover {
            background: #1557b0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .btn-generate:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-loading, .poster-loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a73e8;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-text {
            font-size: 15px;
            line-height: 1.8;
            color: #202124;
        }

        .summary-text h1, .summary-text h2, .summary-text h3 {
            color: #1a73e8;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .summary-text ul {
            margin: 10px 0;
            padding-left: 25px;
        }

        .summary-text li {
            margin: 5px 0;
        }

        .summary-text strong {
            color: #3c4043;
        }

        .summary-disclaimer {
            margin-top: 20px;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-left: 3px solid #dadce0;
            border-radius: 4px;
        }

        .summary-disclaimer p {
            margin: 0;
            font-size: 13px;
            color: #5f6368;
            line-height: 1.5;
        }

        .summary-disclaimer strong {
            color: #3c4043;
        }
        
        .poster-content {
            width: 100%;
            margin-top: 20px;
        }
        
        .poster-iframe {
            width: 100%;
            height: 800px;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>Similar Articles</h1>
                <div class="user-info">
                    <div class="user-icon">{{ current_user.username[0].upper() }}</div>
                    <span>{{ current_user.username }}</span>
                </div>
            </div>
            <div class="source-article" id="source-article">
                <h3>Finding articles similar to:</h3>
                <div class="source-article-title">Loading...</div>
                <div class="source-article-meta"></div>
            </div>
            <div class="nav-buttons">
                <a href="/" class="nav-link">‚Üê Back to Feeds</a>
            </div>
        </div>

        <!-- Summary Section -->
        <div class="summary-section" id="summary-section" style="display: none;">
            <div class="summary-header">
                <h3>AI Summary</h3>
            </div>
            <div class="summary-content" id="summary-content">
                <div class="summary-initial" id="summary-initial">
                    <button class="btn btn-primary btn-generate" id="generate-summary-btn">Generate Summary</button>
                    <button class="btn btn-primary btn-generate" id="generate-poster-btn">Generate Infographic</button>
                </div>
                <div class="summary-loading" id="summary-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating summary...</p>
                </div>
                <div class="poster-loading" id="poster-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating infographic poster...</p>
                    <p style="font-size: 13px; color: #5f6368; margin-top: 10px;">
                        This may take 3-5 minutes. Please wait...
                    </p>
                </div>
                <div class="summary-text" id="summary-text"></div>
                <div class="poster-content" id="poster-content" style="display: none;"></div>
            </div>
        </div>

        <div class="feeds-container">
            <div class="similarity-header">30 Most Similar Articles (Ordered by Similarity)</div>
            <div id="feeds-list">
                <!-- Similar feeds will be loaded here -->
            </div>
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                Finding similar articles...
            </div>
        </div>
    </div>

    <script>
        const sourceFeedId = {{ source_feed_id }};
        const userTimezone = '{{ current_user.timezone }}';

        function calculateScoreColor(score) {
            if (score === null) return 'rgb(149, 165, 166)';

            // Apply gamma transformation (square root) to weight towards red
            const gamma = Math.pow(Math.max(0, Math.min(1, score)), 0.5);
            // Interpolate between gray (149,165,166) and red (231,116,60)
            const r = Math.round(149 + (231 - 149) * gamma);
            const g = Math.round(165 + (116 - 165) * gamma);
            const b = Math.round(166 + (60 - 166) * gamma);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(timestamp * 1000);

            // Format date in user's timezone to YYYY-mm-dd
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                timeZone: userTimezone || 'UTC'
            };

            // Get the parts and reformat to YYYY-mm-dd
            const parts = date.toLocaleDateString('en-US', options).split('/');
            if (parts.length === 3) {
                const [month, day, year] = parts;
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            return date.toLocaleDateString('en-US', options).replace(/\//g, '-');
        }

        function createFeedElement(feed) {
            const scoreColor = calculateScoreColor(feed.score);
            const scoreText = feed.score !== null ? Math.round(feed.score * 100).toString() : 'N/A';
            const similarityText = Math.round(feed.similarity * 100).toString();

            // Create icons for score badge
            let icons = [];
            if (feed.starred) icons.push('<div class="score-icon starred">‚òÖ</div>');
            if (feed.broadcasted) icons.push('<div class="score-icon broadcasted">üì°</div>');
            const iconsHtml = icons.length > 0 ? `<div class="score-icons">${icons.join('')}</div>` : '';

            let labels = [];
            if (feed.starred) labels.push('<span class="label-badge label-starred">‚òÖ Starred</span>');

            // Show vote badges with counts (including current user's vote)
            if (feed.positive_votes > 0 || feed.label === 1) {
                const count = feed.positive_votes || 0;
                labels.push(`<span class="label-badge label-positive">+${count}</span>`);
            }
            if (feed.negative_votes > 0 || feed.label === 0) {
                const count = feed.negative_votes || 0;
                labels.push(`<span class="label-badge label-negative">‚àí${count}</span>`);
            }

            return `
                <div class="feed-item" data-feed-rowid="${feed.rowid}" data-positive-votes="${feed.positive_votes || 0}" data-negative-votes="${feed.negative_votes || 0}">
                    <div class="feed-header">
                        <div class="badges-container">
                            <div class="similarity-badge score-badge">
                                ${similarityText}
                            </div>
                            <div class="score-badge" style="background-color: ${scoreColor};">
                                ${scoreText}
                                ${iconsHtml}
                            </div>
                        </div>
                        <div class="feed-content">
                            <div class="feed-title">${feed.title}</div>
                            <div class="feed-meta">
                                <div class="feed-meta-item feed-origin">${feed.origin || 'Unknown Source'}</div>
                                ${feed.author ? `<div class="feed-meta-item feed-author">${feed.author}</div>` : ''}
                                <div class="feed-meta-item feed-date">${formatDate(feed.published)}</div>
                            </div>
                        </div>
                        ${labels.length > 0 ? `<div class="feed-labels">${labels.join('')}</div>` : ''}
                    </div>
                    <div class="feed-details">
                        <div class="feed-abstract">Loading content...</div>
                        <div class="feed-actions">
                            ${feed.link ? `<a href="${feed.link}" target="_blank" class="btn btn-primary">üìÑ<span class="btn-text"> View Article</span></a>` : ''}
                            <button class="btn btn-star ${feed.starred ? 'starred' : ''}" onclick="starFeed(${feed.rowid}, this)" data-starred="${feed.starred ? 'true' : 'false'}">
                                ${feed.starred ? '‚òÖ' : '‚òÜ'}<span class="btn-text"> ${feed.starred ? 'Starred' : 'Star'}</span>
                            </button>
                            <button class="btn btn-thumbs-up ${feed.label === 1 ? 'active' : ''}" onclick="feedbackFeed(${feed.rowid}, 1, this)" data-label="${feed.label}">
                                üëç<span class="btn-text"> Interested</span>
                            </button>
                            <button class="btn btn-thumbs-down ${feed.label === 0 ? 'active' : ''}" onclick="feedbackFeed(${feed.rowid}, 0, this)" data-label="${feed.label}">
                                üëé<span class="btn-text"> Not Interested</span>
                            </button>
                            <button class="btn btn-similar" onclick="moreLikeThis(${feed.rowid})">
                                üîç<span class="btn-text"> More Like This</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        let similarArticles = [];  // Store articles for summary generation

        function loadSimilarFeeds() {
            fetch(`/api/feeds/${sourceFeedId}/similar`)
                .then(response => response.json())
                .then(data => {
                    // Update source article info
                    if (data.source_article) {
                        document.querySelector('.source-article-title').textContent = data.source_article.title;
                        
                        // Build meta text, skipping empty values
                        const metaParts = [];
                        if (data.source_article.author) metaParts.push(data.source_article.author);
                        if (data.source_article.origin) metaParts.push(data.source_article.origin);
                        
                        document.querySelector('.source-article-meta').textContent = metaParts.join(' ¬∑ ');
                    }

                    // Store articles for summary
                    if (data.similar_feeds) {
                        similarArticles = data.similar_feeds;
                        // Show summary section now that we have articles
                        document.getElementById('summary-section').style.display = 'block';
                    }

                    // Display similar feeds
                    const feedsList = document.getElementById('feeds-list');
                    feedsList.innerHTML = '';

                    if (data.similar_feeds && data.similar_feeds.length > 0) {
                        data.similar_feeds.forEach(feed => {
                            feedsList.insertAdjacentHTML('beforeend', createFeedElement(feed));
                        });
                        document.getElementById('loading').style.display = 'none';
                    } else {
                        document.getElementById('loading').innerHTML = '<div style="padding: 20px; text-align: center; color: #7f8c8d;">No similar articles found</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading similar feeds:', error);
                    document.getElementById('loading').innerHTML = '<div style="padding: 20px; text-align: center; color: #e74c3c;">Error loading similar articles</div>';
                });
        }

        function loadFeedContent(feedRowid, detailsElement) {
            fetch(`/api/feeds/${feedRowid}/content`)
                .then(response => response.json())
                .then(data => {
                    const abstractElement = detailsElement.querySelector('.feed-abstract');
                    if (data.content) {
                        abstractElement.textContent = data.content;
                    } else if (data.tldr) {
                        abstractElement.textContent = data.tldr;
                    } else {
                        abstractElement.textContent = 'No content available';
                    }
                })
                .catch(error => {
                    console.error('Error loading feed content:', error);
                    const abstractElement = detailsElement.querySelector('.feed-abstract');
                    abstractElement.textContent = 'Error loading content';
                });
        }

        function starFeed(feedRowid, buttonElement) {
            event.stopPropagation();

            const isCurrentlyStarred = buttonElement.dataset.starred === 'true';

            buttonElement.disabled = true;
            buttonElement.innerHTML = isCurrentlyStarred ? '‚òÖ<span class="btn-text"> Unstarring...</span>' : '‚òÜ<span class="btn-text"> Starring...</span>';

            fetch(`/api/feeds/${feedRowid}/star`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'toggle'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const feedItem = buttonElement.closest('.feed-item');
                    const labelsDiv = feedItem.querySelector('.feed-labels');

                    if (data.action === 'star') {
                        // Update button state to starred
                        buttonElement.dataset.starred = 'true';
                        buttonElement.innerHTML = '‚òÖ<span class="btn-text"> Starred</span>';
                        buttonElement.classList.add('starred');

                        // Add star label if not exists
                        if (labelsDiv && !labelsDiv.querySelector('.label-starred')) {
                            labelsDiv.insertAdjacentHTML('afterbegin', '<span class="label-badge label-starred">‚òÖ Starred</span>');
                        } else if (!labelsDiv) {
                            const feedHeader = feedItem.querySelector('.feed-header');
                            feedHeader.insertAdjacentHTML('beforeend', '<div class="feed-labels"><span class="label-badge label-starred">‚òÖ Starred</span></div>');
                        }
                    } else {  // unstar
                        // Update button state to unstarred
                        buttonElement.dataset.starred = 'false';
                        buttonElement.innerHTML = '‚òÜ<span class="btn-text"> Star</span>';
                        buttonElement.classList.remove('starred');

                        // Remove star label
                        if (labelsDiv) {
                            const starLabel = labelsDiv.querySelector('.label-starred');
                            if (starLabel) {
                                starLabel.remove();
                                // Remove labels div if empty
                                if (labelsDiv.children.length === 0) {
                                    labelsDiv.remove();
                                }
                            }
                        }
                    }
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error toggling star:', error);
                buttonElement.innerHTML = isCurrentlyStarred ? '‚òÖ<span class="btn-text"> Starred</span>' : '‚òÜ<span class="btn-text"> Star</span>';
                alert('Failed to update star. Please try again.');
            })
            .finally(() => {
                buttonElement.disabled = false;
            });
        }

        function feedbackFeed(feedRowid, score, buttonElement) {
            event.stopPropagation();

            const currentLabel = parseFloat(buttonElement.dataset.label);
            const isRemoving = currentLabel === score;

            buttonElement.disabled = true;
            const otherButton = score === 1
                ? buttonElement.nextElementSibling
                : buttonElement.previousElementSibling;
            if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                otherButton.disabled = true;
            }

            fetch(`/api/feeds/${feedRowid}/feedback`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    score: isRemoving ? null : score
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (isRemoving) {
                        buttonElement.classList.remove('active');
                        buttonElement.dataset.label = '';
                    } else {
                        buttonElement.classList.add('active');
                        buttonElement.dataset.label = score;

                        if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                            otherButton.classList.remove('active');
                            otherButton.dataset.label = '';
                        }
                    }

                    const feedItem = buttonElement.closest('.feed-item');
                    let labelsDiv = feedItem.querySelector('.feed-labels');
                    const existingPositive = labelsDiv ? labelsDiv.querySelector('.label-positive') : null;
                    const existingNegative = labelsDiv ? labelsDiv.querySelector('.label-negative') : null;

                    // Get current vote counts from data attributes
                    let positiveCount = parseInt(feedItem.dataset.positiveVotes) || 0;
                    let negativeCount = parseInt(feedItem.dataset.negativeVotes) || 0;

                    // Adjust counts based on user action
                    if (isRemoving) {
                        if (score === 1) positiveCount = Math.max(0, positiveCount - 1);
                        else if (score === 0) negativeCount = Math.max(0, negativeCount - 1);
                    } else {
                        // Check if switching vote
                        const previousLabel = parseFloat(otherButton?.dataset.label);
                        if (previousLabel === 1 && score === 0) {
                            positiveCount = Math.max(0, positiveCount - 1);
                            negativeCount++;
                        } else if (previousLabel === 0 && score === 1) {
                            negativeCount = Math.max(0, negativeCount - 1);
                            positiveCount++;
                        } else if (score === 1) {
                            positiveCount++;
                        } else if (score === 0) {
                            negativeCount++;
                        }
                    }

                    // Update or remove labels based on new counts
                    if (!labelsDiv && (positiveCount > 0 || negativeCount > 0)) {
                        const feedHeader = feedItem.querySelector('.feed-header');
                        feedHeader.insertAdjacentHTML('beforeend', '<div class="feed-labels"></div>');
                        labelsDiv = feedItem.querySelector('.feed-labels');
                    }

                    // Update positive votes badge
                    if (positiveCount > 0) {
                        if (existingPositive) {
                            existingPositive.textContent = `+${positiveCount}`;
                        } else if (labelsDiv) {
                            labelsDiv.insertAdjacentHTML('beforeend', `<span class="label-badge label-positive">+${positiveCount}</span>`);
                        }
                    } else if (existingPositive) {
                        existingPositive.remove();
                    }

                    // Update negative votes badge
                    if (negativeCount > 0) {
                        if (existingNegative) {
                            existingNegative.textContent = `‚àí${negativeCount}`;
                        } else if (labelsDiv) {
                            labelsDiv.insertAdjacentHTML('beforeend', `<span class="label-badge label-negative">‚àí${negativeCount}</span>`);
                        }
                    } else if (existingNegative) {
                        existingNegative.remove();
                    }

                    // Remove labels div if empty
                    if (labelsDiv && labelsDiv.children.length === 0) {
                        labelsDiv.remove();
                    }

                    // Update the feed data attributes for consistency
                    feedItem.dataset.positiveVotes = positiveCount;
                    feedItem.dataset.negativeVotes = negativeCount;
                } else {
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Error updating feedback:', error);
                alert('Failed to update feedback. Please try again.');
            })
            .finally(() => {
                buttonElement.disabled = false;
                if (otherButton && otherButton.classList.contains(score === 1 ? 'btn-thumbs-down' : 'btn-thumbs-up')) {
                    otherButton.disabled = false;
                }
            });
        }

        function moreLikeThis(feedRowid) {
            event.stopPropagation();
            window.location.href = `/similar/${feedRowid}`;
        }

        // Event delegation for feed item clicks
        document.addEventListener('click', function(e) {
            if (e.target.closest('button') || e.target.closest('a')) return;

            const feedItem = e.target.closest('.feed-item');
            if (!feedItem) return;

            const detailsElement = feedItem.querySelector('.feed-details');
            const isExpanded = feedItem.classList.contains('expanded');

            if (isExpanded) {
                feedItem.classList.remove('expanded');
                detailsElement.classList.remove('expanded');
            } else {
                feedItem.classList.add('expanded');
                detailsElement.classList.add('expanded');

                const abstractElement = detailsElement.querySelector('.feed-abstract');
                if (abstractElement.textContent === 'Loading content...') {
                    loadFeedContent(feedItem.dataset.feedRowid, detailsElement);
                }
            }
        });

        // Summary generation
        document.getElementById('generate-summary-btn').addEventListener('click', function() {
            const btn = this;
            const summaryInitial = document.getElementById('summary-initial');
            const summaryLoading = document.getElementById('summary-loading');
            const summaryText = document.getElementById('summary-text');
            
            // Hide button container and show loading
            summaryInitial.style.display = 'none';
            summaryLoading.style.display = 'block';
            summaryText.innerHTML = '';
            
            // Extract feed IDs from similar articles and include the source article
            const feedIds = [sourceFeedId, ...similarArticles.map(article => article.rowid)];
            
            // Call the summarization API with feed IDs including the source
            fetch('/api/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ feed_ids: feedIds })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    summaryText.innerHTML = data.summary_html + `
                        <div class="summary-disclaimer">
                            <p><strong>Note:</strong> This AI-generated summary is based solely on article titles and abstracts, not the full text. 
                            The summary may contain inaccuracies or miss important details from the complete papers. 
                            Please refer to the original articles for comprehensive information.</p>
                        </div>
                    `;
                } else {
                    summaryText.innerHTML = `<p style="color: #e74c3c;">Failed to generate summary: ${data.error || 'Unknown error'}</p>`;
                    // Show button again on failure
                    summaryInitial.style.display = 'flex';
                }
            })
            .catch(error => {
                console.error('Error generating summary:', error);
                summaryText.innerHTML = '<p style="color: #e74c3c;">An error occurred while generating the summary.</p>';
                // Show button again on error
                summaryInitial.style.display = 'flex';
            })
            .finally(() => {
                summaryLoading.style.display = 'none';
            });
        });

        // Poster generation
        document.getElementById('generate-poster-btn').addEventListener('click', function() {
            const btn = this;
            const summaryInitial = document.getElementById('summary-initial');
            const posterLoading = document.getElementById('poster-loading');
            const summaryText = document.getElementById('summary-text');
            const posterContent = document.getElementById('poster-content');
            
            // Hide button container and show loading
            summaryInitial.style.display = 'none';
            posterLoading.style.display = 'block';
            summaryText.style.display = 'none';
            posterContent.style.display = 'none';
            
            // Extract feed IDs from similar articles and include the source article
            const feedIds = [sourceFeedId, ...similarArticles.map(article => article.rowid)];
            
            // Call the poster generation API to queue the job
            
            fetch('/api/generate-poster', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ feed_ids: feedIds })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.job_id) {
                    // Start polling for job completion
                    const jobId = data.job_id;
                    const pollInterval = setInterval(() => {
                        fetch(`/api/poster-status/${jobId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(statusData => {
                                if (statusData.status === 'completed') {
                                    clearInterval(pollInterval);
                                    posterLoading.style.display = 'none';
                                    
                                    // Create an iframe to display the HTML poster
                                    posterContent.innerHTML = `
                                        <iframe class="poster-iframe" srcdoc="${statusData.poster_html.replace(/"/g, '&quot;')}" frameborder="0"></iframe>
                                        <div class="summary-disclaimer">
                                            <p><strong>Note:</strong> This AI-generated infographic is based solely on article titles and abstracts, not the full text. 
                                            The visualization may contain inaccuracies or miss important details from the complete papers. 
                                            Please refer to the original articles for comprehensive information.</p>
                                        </div>
                                    `;
                                    posterContent.style.display = 'block';
                                    
                                } else if (statusData.status === 'error') {
                                    clearInterval(pollInterval);
                                    posterLoading.style.display = 'none';
                                    
                                    posterContent.innerHTML = `<p style="color: #e74c3c;">Failed to generate poster: ${statusData.error || 'Unknown error'}</p>`;
                                    posterContent.style.display = 'block';
                                    // Show button again on failure
                                    summaryInitial.style.display = 'flex';
                                }
                                // If status is 'pending' or 'processing', continue polling
                            })
                            .catch(error => {
                                clearInterval(pollInterval);
                                posterLoading.style.display = 'none';
                                
                                posterContent.innerHTML = `<p style="color: #e74c3c;">An error occurred while checking job status: ${error.message}</p>`;
                                posterContent.style.display = 'block';
                                // Show button again on error
                                summaryInitial.style.display = 'flex';
                            });
                    }, 3000); // Poll every 3 seconds
                    
                    // Stop polling after 5 minutes
                    setTimeout(() => {
                        clearInterval(pollInterval);
                        if (posterLoading.style.display !== 'none') {
                            posterLoading.style.display = 'none';
                            posterContent.innerHTML = `<p style="color: #e74c3c;">Generation timed out. Please try again.</p>`;
                            posterContent.style.display = 'block';
                            summaryInitial.style.display = 'flex';
                        }
                    }, 300000); // 5 minutes timeout
                    
                } else {
                    throw new Error('Failed to create job');
                }
            })
            .catch(error => {
                posterLoading.style.display = 'none';
                posterContent.innerHTML = `<p style="color: #e74c3c;">An error occurred while generating the poster: ${error.message}</p>`;
                posterContent.style.display = 'block';
                // Show button again on error
                summaryInitial.style.display = 'flex';
            });
        });

        // Initial load
        loadSimilarFeeds();
    </script>
</body>
</html>
