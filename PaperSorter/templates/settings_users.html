{% extends "settings_base.html" %}

{% block title %}Users - Settings - {{ site_name }}{% endblock %}
{% block header_title %}ðŸ‘¥ Users{% endblock %}

{% block page_styles %}

        /* User-specific styles */
        .tag-active {
            background: var(--users-tag-active-bg);
            color: var(--users-tag-active-color);
        }

        .tag-inactive {
            background: var(--users-tag-inactive-bg);
            color: var(--users-tag-inactive-color);
        }

        .form-group small {
            color: var(--users-help-color);
        }

{% endblock %}

{% block settings_content %}
    <div class="action-bar">
            <h2>User Management</h2>
            <button class="btn btn-primary" onclick="openAddModal()">+ Add User</button>
        </div>

        <div id="users-list">
            <!-- Users will be loaded here -->
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ‘¥</div>
                <h3>No users configured</h3>
                <p>Add users to manage preferences and access</p>
            </div>
    {% endblock %}

{% block modals %}
    <!-- Add/Edit User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add User</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="userForm" onsubmit="saveUser(event)">
                <input type="hidden" id="userId">
                <div class="form-group">
                    <label for="userName">Username</label>
                    <input type="text" id="userName" required placeholder="Username">
                </div>
                <div class="form-group">
                    <label for="userPassword">Password (leave blank to keep current)</label>
                    <input type="password" id="userPassword" placeholder="Password">
                </div>
                <div class="form-group">
                    <label for="userTimezone">Timezone</label>
                    <select id="userTimezone" required>
                        <option value="UTC">UTC</option>
                        <option value="America/New_York">America/New_York</option>
                        <option value="America/Chicago">America/Chicago</option>
                        <option value="America/Denver">America/Denver</option>
                        <option value="America/Los_Angeles">America/Los_Angeles</option>
                        <option value="Europe/London">Europe/London</option>
                        <option value="Europe/Paris">Europe/Paris</option>
                        <option value="Europe/Berlin">Europe/Berlin</option>
                        <option value="Asia/Tokyo">Asia/Tokyo</option>
                        <option value="Asia/Seoul" selected>Asia/Seoul</option>
                        <option value="Asia/Shanghai">Asia/Shanghai</option>
                        <option value="Asia/Singapore">Asia/Singapore</option>
                        <option value="Australia/Sydney">Australia/Sydney</option>
                    </select>
                    <small>Timezone for date/time display</small>
                </div>
                <div class="form-group">
                    <label for="userIsAdmin">
                        <input type="checkbox" id="userIsAdmin" style="width: auto; margin-right: 8px;">
                        Administrator privileges
                    </label>
                    <small style="display: block; margin-top: 5px;">Grant admin access to settings and system configuration</small>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block page_scripts %}
    <script>
        let users = [];

        function loadUsers() {
            fetch('/api/settings/users')
                .then(response => response.json())
                .then(data => {
                    users = data.users;
                    renderUsers();
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                });
        }

        function renderUsers() {
            const container = document.getElementById('users-list');

            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ‘¥</div>
                        <h3>No users configured</h3>
                        <p>Add users to manage preferences and access</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Admin</th>
                            <th>Created</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>${user.id}</td>
                                <td><strong>${user.username}</strong></td>
                                <td>${user.is_admin ? '<span class="tag tag-active">Yes</span>' : '<span class="tag tag-inactive">No</span>'}</td>
                                <td>${user.created ? formatDate(user.created) : '-'}</td>
                                <td>${user.lastlogin ? formatDateTime(user.lastlogin) : 'Never'}</td>
                                <td>
                                    <div class="actions">
                                        <button class="btn btn-edit" onclick="editUser(${user.id})">Edit</button>
                                        ${user.id !== 1 ? `<button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete</button>` : ''}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userIsAdmin').checked = false;
            document.getElementById('userModal').style.display = 'block';
        }

        function editUser(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;

            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('userId').value = user.id;
            document.getElementById('userName').value = user.username;
            document.getElementById('userPassword').value = '';
            document.getElementById('userTimezone').value = user.timezone || 'Asia/Seoul';
            document.getElementById('userIsAdmin').checked = user.is_admin || false;
            document.getElementById('userModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function saveUser(event) {
            event.preventDefault();

            const id = document.getElementById('userId').value;
            const data = {
                username: document.getElementById('userName').value,
                timezone: document.getElementById('userTimezone').value,
                is_admin: document.getElementById('userIsAdmin').checked
            };

            const password = document.getElementById('userPassword').value;
            if (password) {
                data.password = password;
            }

            const url = id ? `/api/settings/users/${id}` : '/api/settings/users';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    loadUsers();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error saving user:', error);
                alert('Failed to save user');
            });
        }

        function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            fetch(`/api/settings/users/${id}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUsers();
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                alert('Failed to delete user');
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('userModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Load users on page load
        loadUsers();
    </script>
{% endblock %}